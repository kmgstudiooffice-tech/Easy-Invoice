<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Invoice - 自動請求書メーカー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }

        /* 印刷時のスタイル */
        @media print {
            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .print-area {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            @page { margin: 0; size: A4; }
            .invoice-sheet {
                margin: 0;
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                page-break-after: always;
                border: none !important;
                box-shadow: none !important;
            }
        }

        .invoice-sheet {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            transition: opacity 0.3s;
        }
        
        .blur-preview {
            opacity: 0.5;
            filter: blur(2px);
            pointer-events: none;
        }

        /* ハンコ風スタイル */
        .stamp-box {
            width: 60px;
            height: 60px;
            border: 2px solid #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            font-weight: bold;
            font-size: 14px;
            transform: rotate(-15deg);
            opacity: 0.8;
            position: absolute;
            right: 10px;
            bottom: 10px;
            pointer-events: none;
        }

        /* スクロールバーカスタマイズ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden">

    <!-- 共通ヘッダー -->
    <header class="bg-indigo-600 text-white p-4 shadow-md z-10 no-print flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2 cursor-pointer" onclick="showScreen('home')">
            <i class="fa-solid fa-file-invoice text-2xl"></i>
            <h1 class="text-xl font-bold">Easy Invoice</h1>
        </div>
        <div id="header-actions-home" class="flex gap-2">
            <!-- ホーム画面用のアクション -->
            <button onclick="createNewInvoice()" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-bold hover:bg-indigo-50 transition shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">新規作成</span>
            </button>
        </div>
        <div id="header-actions-editor" class="hidden flex items-center gap-2 sm:gap-4">
            <!-- 編集画面用のアクション -->
            <button onclick="saveInvoice()" class="text-indigo-100 hover:text-white font-medium flex items-center gap-1">
                <i class="fa-regular fa-floppy-disk"></i> <span class="hidden sm:inline">保存</span>
            </button>
            <div class="h-6 w-px bg-indigo-400 mx-1"></div>
            <button onclick="showScreen('home')" class="text-indigo-100 hover:text-white font-medium flex items-center gap-1">
                <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">一覧へ</span>
            </button>
        </div>
    </header>

    <!-- メインコンテンツエリア -->
    <div class="flex-1 overflow-hidden relative bg-gray-100">

        <!-- ==================== ホーム画面 (一覧) ==================== -->
        <div id="screen-home" class="h-full overflow-y-auto p-4 sm:p-8 max-w-5xl mx-auto w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">請求書一覧</h2>
                <div class="text-sm text-gray-500" id="invoice-count">0件</div>
            </div>

            <div id="invoice-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- JSでリスト生成 -->
            </div>
        </div>

        <!-- ==================== 編集・プレビュー画面 ==================== -->
        <!-- 初期状態はJSでクラス制御して中央配置にします -->
        <div id="screen-editor" class="hidden h-full flex flex-col md:flex-row h-full transition-all duration-500">
            
            <!-- 左側：入力フォーム -->
            <!-- 初期状態: w-full max-w-3xl mx-auto rounded-xl shadow-2xl h-auto max-h-[90%] -->
            <!-- プレビュー時: w-full md:w-5/12 lg:w-4/12 bg-white border-r h-full -->
            <div id="editor-area" class="w-full md:w-5/12 lg:w-4/12 bg-white border-r border-gray-200 overflow-y-auto p-4 sm:p-6 no-print pb-24 shadow-inner custom-scrollbar z-10 transition-all duration-500 ease-in-out">
                
                <!-- ツールバー -->
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-white/95 backdrop-blur py-2 border-b z-20">
                    <div class="text-sm font-bold text-gray-500">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> 編集モード
                    </div>
                    <!-- プレビュー反映ボタン -->
                    <button onclick="updatePreview(true)" class="bg-indigo-600 text-white px-4 py-1.5 rounded-md text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center gap-2 animate-pulse-once">
                        <i class="fa-solid fa-rotate"></i> プレビュー反映
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- 基本情報 -->
                    <section>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">基本情報</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">件名 <span class="text-red-500">*</span></label>
                                <input type="text" id="input-title" placeholder="例: 10月分ご請求" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">請求日</label>
                                    <input type="date" id="input-date" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">請求書番号</label>
                                    <input type="text" id="input-number" placeholder="INV-001" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 取引先・自社情報 -->
                    <section>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">宛名・差出人</h3>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                                <label class="block text-xs font-bold text-blue-800 mb-1">請求先</label>
                                <input type="text" id="input-client" placeholder="相手先の会社名・氏名" class="w-full border-gray-300 border rounded-md p-2 mb-2 bg-white">
                                <input type="text" id="input-client-dept" placeholder="部署・担当者名 (任意)" class="w-full border-gray-300 border rounded-md p-2 text-sm bg-white">
                            </div>

                            <div class="bg-green-50 p-3 rounded-md border border-green-100">
                                <label class="block text-xs font-bold text-green-800 mb-1">請求元 (自社)</label>
                                <input type="text" id="input-my-company" placeholder="自社の名前" class="w-full border-gray-300 border rounded-md p-2 mb-2 bg-white">
                                <input type="text" id="input-my-address" placeholder="住所" class="w-full border-gray-300 border rounded-md p-2 text-sm mb-2 bg-white">
                                <div>
                                    <input type="text" id="input-my-tel" placeholder="電話番号" class="w-full border-gray-300 border rounded-md p-2 text-sm mb-2 bg-white">
                                    <input type="text" id="input-my-invoice-num" placeholder="登録番号 T1234..." class="w-full border-gray-300 border rounded-md p-2 text-sm bg-white">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 品目リスト -->
                    <section>
                        <div class="flex justify-between items-center mb-3 border-b pb-1">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">請求項目</h3>
                            <button onclick="addItem()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 font-bold"><i class="fa-solid fa-plus"></i> 行追加</button>
                        </div>
                        
                        <div id="items-container" class="space-y-3">
                            <!-- JSで項目が追加されます -->
                        </div>
                    </section>

                    <!-- 備考・振込先 -->
                    <section>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">振込先・備考</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">振込先銀行</label>
                                <textarea id="input-bank" rows="3" class="w-full border-gray-300 border rounded-md p-2 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">備考</label>
                                <textarea id="input-notes" rows="2" class="w-full border-gray-300 border rounded-md p-2 text-sm"></textarea>
                            </div>
                        </div>
                    </section>

                    <!-- 保存ボタン (SP用) -->
                    <div class="md:hidden pt-4 pb-8">
                        <button onclick="saveInvoice()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-lg">
                            <i class="fa-regular fa-floppy-disk"></i> 保存して一覧に戻る
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右側：プレビューエリア -->
            <div id="preview-area" class="flex-1 bg-gray-500 overflow-auto p-4 md:p-8 flex justify-center items-start print-area-wrapper relative hidden">
                
                <!-- プレビュー更新ボタン (Floating) -->
                <div class="absolute top-4 right-4 z-20 flex gap-2 no-print">
                     <button onclick="window.print()" class="bg-white text-gray-700 px-4 py-2 rounded-lg font-bold shadow hover:bg-gray-50 transition flex items-center gap-2">
                        <i class="fa-solid fa-print"></i> 印刷/PDF
                    </button>
                </div>

                <!-- A4用紙 -->
                <div id="invoice-preview" class="invoice-sheet print-area text-black text-sm transition-all duration-500">
                    
                    <!-- ヘッダーエリア -->
                    <div class="flex justify-between items-end border-b-2 border-indigo-900 pb-4 mb-8">
                        <h1 id="preview-title" class="text-3xl font-bold text-indigo-900 tracking-widest">請求書</h1>
                        <div class="text-right">
                            <div class="text-gray-500 text-xs">請求書番号</div>
                            <div id="preview-number" class="font-mono text-lg font-bold"></div>
                            <div class="text-gray-500 text-xs mt-1">請求日</div>
                            <div id="preview-date"></div>
                        </div>
                    </div>

                    <!-- 宛名・差出人 -->
                    <div class="flex justify-between mb-12">
                        <div class="w-1/2 pr-4">
                            <div id="preview-client" class="text-xl font-bold border-b border-gray-400 pb-1 mb-1 inline-block min-w-[200px] min-h-[30px]"></div>
                            <span class="text-lg">御中</span>
                            <div id="preview-client-dept" class="mt-1 text-sm text-gray-600"></div>
                            
                            <div class="mt-8">
                                <div class="text-sm bg-gray-100 p-2 inline-block rounded">
                                    <span class="font-bold">ご請求金額</span>
                                    <span id="preview-total-highlight" class="block text-3xl font-bold border-b-2 border-black mt-1">¥0-</span>
                                </div>
                            </div>
                        </div>

                        <div class="w-1/2 pl-4 text-right relative">
                            <div id="preview-my-company" class="text-lg font-bold mb-1 min-h-[28px]"></div>
                            <div id="preview-my-address" class="text-sm text-gray-600 mb-1"></div>
                            <div id="preview-my-tel" class="text-sm text-gray-600 mb-1"></div>
                            <div id="preview-my-invoice-num" class="text-xs text-gray-500 mt-2"></div>
                            
                            <!-- ハンコ -->
                            <div class="stamp-box">
                                検印
                            </div>
                        </div>
                    </div>

                    <!-- 明細テーブル -->
                    <table class="w-full mb-8 border-collapse">
                        <thead>
                            <tr class="bg-indigo-900 text-white">
                                <th class="p-2 text-left w-5/12">内容</th>
                                <th class="p-2 text-center w-2/12">単価</th>
                                <th class="p-2 text-center w-1/12">数量</th>
                                <th class="p-2 text-center w-1/12">単位</th>
                                <th class="p-2 text-center w-1/12">税(率)</th>
                                <th class="p-2 text-right w-2/12">金額</th>
                            </tr>
                        </thead>
                        <tbody id="preview-items-body">
                            <!-- JSで生成 -->
                        </tbody>
                    </table>

                    <!-- 計算エリア -->
                    <div class="flex justify-end mb-12">
                        <div class="w-1/2 lg:w-5/12">
                            <div class="flex justify-between border-b border-gray-300 py-1">
                                <span>小計 (税抜)</span>
                                <span id="preview-subtotal" class="font-mono">¥0</span>
                            </div>
                            
                            <!-- 動的税金エリア -->
                            <div id="preview-tax-breakdown">
                                <!-- JSで税率ごとに生成 -->
                            </div>
                            
                            <div class="flex justify-between border-b border-gray-300 py-1 text-sm">
                                <span>消費税合計</span>
                                <span id="preview-tax-total" class="font-mono">¥0</span>
                            </div>
                            <div class="flex justify-between border-b-2 border-indigo-900 py-2 text-lg font-bold mt-2">
                                <span>合計金額 (税込)</span>
                                <span id="preview-grand-total" class="font-mono">¥0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 備考・振込先 -->
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-bold border-b border-gray-400 mb-2 text-sm">お振込先</h4>
                            <div id="preview-bank" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600"></div>
                        </div>
                        <div>
                            <h4 class="font-bold border-b border-gray-400 mb-2 text-sm">備考</h4>
                            <div id="preview-notes" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center gap-3 z-50">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toast-message">保存しました</span>
    </div>

    <script>
        // グローバル変数
        let items = [];
        let currentInvoiceId = null; // 編集中・新規作成中のID
        let invoiceList = []; // 保存済みデータリスト
        let isPreviewVisible = false; // プレビュー表示フラグ

        // ローカルストレージキー
        const STORAGE_KEY = 'easy_invoice_data_v5';

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadInvoices();
            showScreen('home');
        });

        // ==================== 画面遷移 ====================
        function showScreen(screenId) {
            const homeScreen = document.getElementById('screen-home');
            const editorScreen = document.getElementById('screen-editor');
            const headerHome = document.getElementById('header-actions-home');
            const headerEditor = document.getElementById('header-actions-editor');

            if (screenId === 'home') {
                homeScreen.classList.remove('hidden');
                editorScreen.classList.add('hidden');
                headerHome.classList.remove('hidden');
                headerEditor.classList.add('hidden');
                loadInvoices(); // リスト更新
            } else {
                homeScreen.classList.add('hidden');
                editorScreen.classList.remove('hidden');
                headerHome.classList.add('hidden');
                headerEditor.classList.remove('hidden');
            }
        }

        // ==================== レイアウト制御 (集中モード) ====================
        function togglePreviewLayout(show) {
            const screenEditor = document.getElementById('screen-editor');
            const editorArea = document.getElementById('editor-area');
            const previewArea = document.getElementById('preview-area');

            isPreviewVisible = show;

            if (!show) {
                // プレビュー非表示（集中モード）: 入力エリアを中央配置
                screenEditor.classList.remove('md:flex-row', 'items-start');
                screenEditor.classList.add('items-center', 'justify-center', 'p-4');
                
                editorArea.className = "w-full max-w-3xl bg-white shadow-2xl rounded-xl border border-gray-200 overflow-y-auto p-6 no-print pb-24 custom-scrollbar z-10 h-auto max-h-[90vh]";
                
                previewArea.classList.add('hidden');
            } else {
                // プレビュー表示（分割モード）
                screenEditor.classList.remove('items-center', 'justify-center', 'p-4');
                screenEditor.classList.add('md:flex-row', 'items-start');

                editorArea.className = "w-full md:w-5/12 lg:w-4/12 bg-white border-r border-gray-200 overflow-y-auto p-4 sm:p-6 no-print pb-24 shadow-inner custom-scrollbar z-10 h-full";
                
                previewArea.classList.remove('hidden');
            }
        }

        // ==================== データ管理 (CRUD) ====================
        
        function loadInvoices() {
            const data = localStorage.getItem(STORAGE_KEY);
            invoiceList = data ? JSON.parse(data) : [];
            renderInvoiceList();
        }

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(invoiceList));
        }

        function createNewInvoice() {
            currentInvoiceId = Date.now().toString();
            clearForm();
            
            // 1行だけ空の項目を追加（デフォルト税率10%）
            items = [{ id: Date.now(), name: "", price: 0, qty: 1, unit: "式", taxRate: 10, taxAmount: 0 }];
            
            renderItems();
            
            // 初期状態はプレビューを隠して中央配置
            togglePreviewLayout(false);
            
            showScreen('editor');
        }

        function editInvoice(id) {
            const invoice = invoiceList.find(v => v.id === id);
            if (!invoice) return;

            currentInvoiceId = invoice.id;
            
            // フォームへの値セット
            document.getElementById('input-title').value = invoice.title || '';
            document.getElementById('input-number').value = invoice.number || '';
            document.getElementById('input-date').value = invoice.date || '';
            
            document.getElementById('input-client').value = invoice.client || '';
            document.getElementById('input-client-dept').value = invoice.clientDept || '';
            
            document.getElementById('input-my-company').value = invoice.myCompany || '';
            document.getElementById('input-my-address').value = invoice.myAddress || '';
            document.getElementById('input-my-tel').value = invoice.myTel || '';
            document.getElementById('input-my-invoice-num').value = invoice.myInvoiceNum || '';

            document.getElementById('input-bank').value = invoice.bank || '';
            document.getElementById('input-notes').value = invoice.notes || '';

            // 旧データ互換性 & 税額計算
            items = (invoice.items || []).map(item => {
                let newItem = { ...item };
                if (newItem.taxRate < 1 && newItem.taxRate > 0) {
                    newItem.taxRate = newItem.taxRate * 100;
                }
                if (newItem.taxAmount === undefined) {
                    newItem.taxAmount = Math.floor((newItem.price * newItem.qty) * (newItem.taxRate / 100));
                }
                return newItem;
            });

            renderItems();

            // 編集モード開始時も、まずは集中モード（プレビューなし）で開始
            togglePreviewLayout(false);
            
            showScreen('editor');
        }

        function saveInvoice() {
            let title = document.getElementById('input-title').value;
            if(!title.trim()) {
                title = "名称未設定の請求書";
                document.getElementById('input-title').value = title;
            }

            const data = {
                id: currentInvoiceId,
                updatedAt: new Date().toISOString(),
                title: title,
                number: document.getElementById('input-number').value,
                date: document.getElementById('input-date').value,
                
                client: document.getElementById('input-client').value,
                clientDept: document.getElementById('input-client-dept').value,
                
                myCompany: document.getElementById('input-my-company').value,
                myAddress: document.getElementById('input-my-address').value,
                myTel: document.getElementById('input-my-tel').value,
                myInvoiceNum: document.getElementById('input-my-invoice-num').value,
                
                bank: document.getElementById('input-bank').value,
                notes: document.getElementById('input-notes').value,
                
                items: items,
                total: calculateTotal()
            };

            const index = invoiceList.findIndex(v => v.id === currentInvoiceId);
            if (index >= 0) {
                invoiceList[index] = data;
            } else {
                invoiceList.unshift(data);
            }

            saveToStorage();
            showToast("保存しました");
        }

        function deleteInvoice(id, event) {
            event.stopPropagation();
            if(!confirm('本当にこの請求書を削除しますか？')) return;
            
            invoiceList = invoiceList.filter(v => v.id !== id);
            saveToStorage();
            renderInvoiceList();
            showToast("削除しました");
        }

        function renderInvoiceList() {
            const container = document.getElementById('invoice-list');
            document.getElementById('invoice-count').innerText = `${invoiceList.length}件`;

            if (invoiceList.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-20 text-gray-400">
                        <i class="fa-regular fa-folder-open text-5xl mb-4"></i>
                        <p>保存された請求書はありません</p>
                        <button onclick="createNewInvoice()" class="mt-4 text-indigo-600 font-bold hover:underline">新規作成する</button>
                    </div>`;
                return;
            }

            container.innerHTML = invoiceList.map(inv => `
                <div onclick="editInvoice('${inv.id}')" class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-indigo-300 transition cursor-pointer relative group">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-indigo-900 truncate pr-8">${inv.title}</h3>
                        <button onclick="deleteInvoice('${inv.id}', event)" class="text-gray-400 hover:text-red-500 transition px-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 mb-4">
                        <p class="truncate"><i class="fa-regular fa-building mr-1"></i> ${inv.client || '（宛名なし）'}</p>
                        <p class="text-xs text-gray-400 mt-1">${inv.date ? formatDate(inv.date) : '日付なし'}</p>
                    </div>
                    <div class="flex justify-between items-end border-t pt-3">
                        <span class="text-xs text-gray-400">合計金額 (税込)</span>
                        <span class="text-xl font-bold text-gray-800">¥${(inv.total || 0).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // ==================== 編集・入力機能 ====================

        function clearForm() {
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => input.value = '');
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-3 border rounded shadow-sm relative group";
                
                div.innerHTML = `
                    <button onclick="removeItem(${index})" class="absolute -right-2 -top-2 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow hover:bg-red-500 z-10 transition-colors">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <!-- 12グリッドレイアウト -->
                    <div class="grid grid-cols-12 gap-2 items-end">
                        <div class="col-span-12 md:col-span-4">
                            <label class="text-xs text-gray-500 block">内容</label>
                            <input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)" class="w-full border p-1.5 rounded text-sm bg-white focus:ring-1 focus:ring-indigo-500">
                        </div>
                        
                        <div class="col-span-4 md:col-span-2">
                            <label class="text-xs text-gray-500 block">単価</label>
                            <input type="number" value="${item.price}" onchange="updateItem(${index}, 'price', this.value)" class="w-full border p-1.5 rounded text-sm text-right bg-white focus:ring-1 focus:ring-indigo-500">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="text-xs text-gray-500 block">数量</label>
                            <input type="number" value="${item.qty}" onchange="updateItem(${index}, 'qty', this.value)" class="w-full border p-1.5 rounded text-sm text-right bg-white focus:ring-1 focus:ring-indigo-500">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="text-xs text-gray-500 block">単位</label>
                            <input type="text" value="${item.unit}" onchange="updateItem(${index}, 'unit', this.value)" class="w-full border p-1.5 rounded text-sm text-center bg-white focus:ring-1 focus:ring-indigo-500">
                        </div>

                        <div class="col-span-4 md:col-span-2">
                            <label class="text-xs text-gray-500 block">税率/税額</label>
                            <div class="flex flex-col gap-1">
                                <div class="relative">
                                    <input type="number" value="${item.taxRate}" onchange="updateItem(${index}, 'taxRate', this.value)" class="w-full border p-1 rounded text-xs text-right bg-white focus:ring-1 focus:ring-indigo-500 pr-5" placeholder="率">
                                    <span class="absolute right-1 top-1 text-[10px] text-gray-400">%</span>
                                </div>
                                <div class="relative">
                                    <input type="number" value="${item.taxAmount}" onchange="updateItem(${index}, 'taxAmount', this.value)" class="w-full border p-1 rounded text-xs text-right bg-white text-indigo-700 font-medium focus:ring-1 focus:ring-indigo-500 pr-5" placeholder="額">
                                    <span class="absolute right-1 top-1 text-[10px] text-gray-400">円</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-span-12 md:col-span-2">
                            <label class="text-xs text-gray-500 block">金額(税込)</label>
                            <input type="text" value="¥${((item.price * item.qty) + item.taxAmount).toLocaleString()}" readonly class="w-full border p-1.5 rounded text-sm text-right bg-gray-100 text-gray-500">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateItem(index, field, value) {
            let val = parseFloat(value);
            if (isNaN(val) && field !== 'name' && field !== 'unit') val = 0;
            
            if (field !== 'name' && field !== 'unit') {
                items[index][field] = val;
            } else {
                items[index][field] = value;
            }

            // 自動計算ロジック
            if (field === 'price' || field === 'qty' || field === 'taxRate') {
                const subtotal = items[index].price * items[index].qty;
                items[index].taxAmount = Math.floor(subtotal * (items[index].taxRate / 100));
            }

            renderItems();
        }

        function addItem() {
            items.push({ id: Date.now(), name: "", price: 0, qty: 1, unit: "式", taxRate: 10, taxAmount: 0 });
            renderItems();
        }

        function removeItem(index) {
            items.splice(index, 1);
            renderItems();
        }

        // ==================== プレビュー & 計算 ====================

        function calculateTotal() {
            let total = 0;
            items.forEach(item => {
                const subtotal = item.price * item.qty;
                total += subtotal + item.taxAmount;
            });
            return total;
        }

        function updatePreview(showLayout = false) {
            // レイアウト変更が必要な場合（ボタンクリック時など）
            if (showLayout && !isPreviewVisible) {
                togglePreviewLayout(true);
            }

            setText('preview-title', document.getElementById('input-title').value);
            setText('preview-number', document.getElementById('input-number').value);
            setText('preview-date', formatDate(document.getElementById('input-date').value));
            setText('preview-client', document.getElementById('input-client').value);
            setText('preview-client-dept', document.getElementById('input-client-dept').value);
            setText('preview-my-company', document.getElementById('input-my-company').value);
            setText('preview-my-address', document.getElementById('input-my-address').value);
            setText('preview-my-tel', document.getElementById('input-my-tel').value);
            setText('preview-my-invoice-num', document.getElementById('input-my-invoice-num').value);
            setText('preview-bank', document.getElementById('input-bank').value);
            setText('preview-notes', document.getElementById('input-notes').value);

            const tbody = document.getElementById('preview-items-body');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            let taxBreakdown = {};

            items.forEach(item => {
                const rowPrice = item.price * item.qty;
                subtotal += rowPrice;
                
                const rateKey = item.taxRate;
                if (!taxBreakdown[rateKey]) {
                    taxBreakdown[rateKey] = { taxable: 0, tax: 0 };
                }
                taxBreakdown[rateKey].taxable += rowPrice;
                taxBreakdown[rateKey].tax += item.taxAmount;

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200";
                tr.innerHTML = `
                    <td class="p-2 text-left">${item.name}</td>
                    <td class="p-2 text-center">¥${item.price.toLocaleString()}</td>
                    <td class="p-2 text-center">${item.qty}</td>
                    <td class="p-2 text-center">${item.unit}</td>
                    <td class="p-2 text-center text-xs text-gray-500">
                        ${item.taxRate}%<br>
                        <span class="text-[10px] text-gray-400">(¥${item.taxAmount})</span>
                    </td>
                    <td class="p-2 text-right font-mono">¥${rowPrice.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });

            // 税計算・表示
            let totalTax = 0;
            const breakdownContainer = document.getElementById('preview-tax-breakdown');
            breakdownContainer.innerHTML = '';

            Object.keys(taxBreakdown).sort((a, b) => b - a).forEach(rate => {
                if (parseFloat(rate) === 0 && taxBreakdown[rate].tax === 0) return; 

                const data = taxBreakdown[rate];
                totalTax += data.tax;

                const div = document.createElement('div');
                div.className = "flex justify-between border-b border-gray-300 py-1 text-xs text-gray-500";
                div.innerHTML = `
                    <span>(内 ${rate}%対象 ¥${data.taxable.toLocaleString()}) 消費税</span>
                    <span class="font-mono">¥${data.tax.toLocaleString()}</span>
                `;
                breakdownContainer.appendChild(div);
            });

            const grandTotal = subtotal + totalTax;

            setText('preview-subtotal', `¥${subtotal.toLocaleString()}`);
            setText('preview-tax-total', `¥${totalTax.toLocaleString()}`);
            setText('preview-grand-total', `¥${grandTotal.toLocaleString()}`);
            setText('preview-total-highlight', `¥${grandTotal.toLocaleString()}-`);
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if(el) el.innerText = value;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('translate-y-20');
            setTimeout(() => {
                toast.classList.add('translate-y-20');
            }, 3000);
        }
    </script>
</body>
</html>

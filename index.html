<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Easy Invoice - 自動無料請求書作成ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- PDF生成用ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            height: 100dvh; /* モバイルブラウザのアドレスバー対策 */
            overscroll-behavior-y: none;
        }

        /* 印刷時のスタイル */
        @media print {
            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
                height: auto;
                overflow: visible;
            }
            .no-print { display: none !important; }
            .print-area {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                transform: none !important;
            }
            @page { margin: 0; size: A4; }
            .invoice-sheet {
                margin: 0;
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                page-break-after: always;
                border: none !important;
                box-shadow: none !important;
            }
            #preview-scaler { width: auto !important; height: auto !important; }
        }

        .invoice-sheet {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            transform-origin: top left;
        }
        
        .scroll-touch { -webkit-overflow-scrolling: touch; }

        .stamp-box {
            width: 60px;
            height: 60px;
            border: 2px solid #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            font-weight: bold;
            font-size: 16px;
            transform: rotate(-15deg);
            opacity: 0.8;
            position: absolute;
            right: 10px;
            bottom: 10px;
            pointer-events: none;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* ローディングオーバーレイ */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* モーダル */
        #history-modal {
            transition: opacity 0.2s, visibility 0.2s;
        }
        #history-modal.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #history-modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
    </style>
</head>
<body class="text-gray-700 flex flex-col overflow-hidden">

    <!-- ローディング画面 -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-indigo-900 font-bold animate-pulse">PDFを高画質で作成中...</p>
    </div>

    <!-- 履歴選択モーダル -->
    <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[80vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 id="modal-title" class="font-bold text-gray-800"><i class="fa-solid fa-clock-rotate-left mr-2"></i>履歴を選択</h3>
                <button onclick="toggleHistoryModal(false)" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <div id="history-list" class="overflow-y-auto p-2 custom-scrollbar flex-1">
                <!-- JSでリスト生成 -->
            </div>
            <div class="p-3 border-t bg-gray-50 text-right">
                <button onclick="toggleHistoryModal(false)" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-200 rounded transition">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 共通ヘッダー -->
    <header class="bg-indigo-600 text-white p-3 md:p-4 shadow-md z-10 no-print flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2 cursor-pointer" onclick="showScreen('home')">
            <i class="fa-solid fa-file-invoice text-xl md:text-2xl"></i>
            <h1 class="text-lg md:text-xl font-bold">Easy Invoice</h1>
        </div>
        <div id="header-actions-home" class="flex gap-2">
            <button onclick="createNewInvoice()" class="bg-white text-indigo-600 px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-bold hover:bg-indigo-50 transition shadow-sm flex items-center gap-2 text-sm md:text-base">
                <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">新規作成</span><span class="sm:hidden">新規</span>
            </button>
        </div>
        <div id="header-actions-editor" class="hidden flex items-center gap-2 sm:gap-4">
            <button onclick="saveInvoice()" class="text-indigo-100 hover:text-white font-medium flex items-center gap-1 text-sm md:text-base">
                <i class="fa-regular fa-floppy-disk"></i> <span class="hidden sm:inline">保存</span>
            </button>
            <div class="h-5 md:h-6 w-px bg-indigo-400 mx-1"></div>
            <button onclick="showScreen('home')" class="text-indigo-100 hover:text-white font-medium flex items-center gap-1 text-sm md:text-base">
                <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">一覧へ</span>
            </button>
        </div>
    </header>

    <!-- メインコンテンツエリア -->
    <div class="flex-1 overflow-hidden relative bg-gray-100 w-full">

        <!-- ==================== ホーム画面 (一覧) ==================== -->
        <div id="screen-home" class="h-full overflow-y-auto p-4 sm:p-8 max-w-5xl mx-auto w-full scroll-touch">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">請求書一覧</h2>
                <div class="text-sm text-gray-500" id="invoice-count">0件</div>
            </div>

            <div id="invoice-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                <!-- JSでリスト生成 -->
            </div>
        </div>

        <!-- ==================== 編集・プレビュー画面 ==================== -->
        <div id="screen-editor" class="hidden h-full flex flex-col md:flex-row h-full transition-all duration-300">
            
            <!-- 左側：入力フォーム -->
            <div id="editor-area" class="w-full md:w-5/12 lg:w-4/12 bg-white border-r border-gray-200 overflow-y-auto p-4 sm:p-6 no-print pb-32 md:pb-24 shadow-inner custom-scrollbar z-20 transition-all duration-300 ease-in-out scroll-touch">
                
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-white/95 backdrop-blur py-2 border-b z-20">
                    <div class="text-xs md:text-sm font-bold text-gray-500 flex items-center gap-2">
                        <span class="bg-gray-100 px-2 py-1 rounded"><i class="fa-solid fa-pen-to-square mr-1"></i>編集</span>
                        <span id="save-status" class="text-xs font-normal text-green-600 hidden scale-0 transition-transform duration-300"><i class="fa-solid fa-check"></i> 保存済</span>
                    </div>
                    <button onclick="updatePreview(true)" class="bg-indigo-600 text-white px-3 py-1.5 md:px-4 rounded-md text-xs md:text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-rotate"></i> プレビュー
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- 基本情報 -->
                    <section>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">基本情報</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">件名 <span class="text-red-500">*</span></label>
                                <input type="text" id="input-title" oninput="triggerAutoSave()" placeholder="例: 10月分ご請求" class="w-full border-gray-300 border rounded-md p-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">請求日</label>
                                    <input type="date" id="input-date" oninput="triggerAutoSave()" class="w-full border-gray-300 border rounded-md p-2 text-sm focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">請求書番号</label>
                                    <input type="text" id="input-number" oninput="triggerAutoSave()" placeholder="INV-001" class="w-full border-gray-300 border rounded-md p-2 text-sm focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <!-- 支払期限 -->
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">お支払い期限 <span class="text-xs font-normal text-gray-400">(自由記入)</span></label>
                                    <input type="text" id="input-deadline" oninput="triggerAutoSave()" placeholder="例: 2023年10月末日、受領後1週間以内など" class="w-full border-gray-300 border rounded-md p-2 text-sm focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 取引先・自社情報 -->
                    <section>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">宛名・差出人</h3>
                        <div class="space-y-4">
                            <!-- 宛先 -->
                            <div class="bg-blue-50 p-3 rounded-md border border-blue-100 relative group-hover:border-blue-300 transition">
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-xs font-bold text-blue-800">請求先</label>
                                    <button onclick="toggleHistoryModal('client')" class="text-xs bg-white text-blue-600 px-2 py-0.5 rounded border border-blue-200 hover:bg-blue-50 shadow-sm transition">
                                        <i class="fa-solid fa-history mr-1"></i>履歴
                                    </button>
                                </div>
                                <input type="text" id="input-client" oninput="triggerAutoSave()" placeholder="相手先の会社名・氏名" class="w-full border-gray-300 border rounded-md p-2 mb-2 bg-white text-sm">
                                <input type="text" id="input-client-dept" oninput="triggerAutoSave()" placeholder="部署・担当者名 (任意)" class="w-full border-gray-300 border rounded-md p-2 text-sm bg-white">
                            </div>

                            <!-- 自社 -->
                            <div class="bg-green-50 p-3 rounded-md border border-green-100 relative">
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-xs font-bold text-green-800">請求元 (自社)</label>
                                    <button onclick="toggleHistoryModal('company')" class="text-xs bg-white text-green-600 px-2 py-0.5 rounded border border-green-200 hover:bg-green-50 shadow-sm transition">
                                        <i class="fa-solid fa-history mr-1"></i>履歴
                                    </button>
                                </div>
                                <input type="text" id="input-my-company" oninput="triggerAutoSave()" placeholder="自社の名前" class="w-full border-gray-300 border rounded-md p-2 mb-2 bg-white text-sm">
                                <input type="text" id="input-my-address" oninput="triggerAutoSave()" placeholder="住所" class="w-full border-gray-300 border rounded-md p-2 text-sm mb-2 bg-white">
                                <div class="mb-2">
                                    <input type="text" id="input-my-tel" oninput="triggerAutoSave()" placeholder="電話番号" class="w-full border-gray-300 border rounded-md p-2 text-sm mb-2 bg-white">
                                </div>
                                
                                <!-- インボイス番号トグル -->
                                <div class="pt-2 border-t border-green-200">
                                    <label class="flex items-center gap-2 cursor-pointer mb-2 group">
                                        <div class="relative">
                                            <input type="checkbox" id="toggle-invoice-num" onchange="toggleInvoiceNum()" class="sr-only peer">
                                            <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                                        </div>
                                        <span class="text-xs text-gray-700 font-bold group-hover:text-green-800 transition">インボイス(登録)番号を表示</span>
                                    </label>
                                    
                                    <div id="invoice-num-container" class="hidden transition-all duration-300">
                                        <input type="text" id="input-my-invoice-num" oninput="triggerAutoSave()" placeholder="登録番号 T1234..." class="w-full border-gray-300 border rounded-md p-2 text-sm bg-white">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 品目リスト -->
                    <section>
                        <div class="flex justify-between items-center mb-3 border-b pb-1">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">請求項目</h3>
                            <button onclick="addItem()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 font-bold"><i class="fa-solid fa-plus"></i> 行追加</button>
                        </div>
                        
                        <div id="items-container" class="space-y-3"></div>
                    </section>

                    <!-- 備考・振込先 -->
                    <section>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">振込先・備考</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">振込先銀行</label>
                                <textarea id="input-bank" oninput="triggerAutoSave()" rows="3" class="w-full border-gray-300 border rounded-md p-2 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">備考</label>
                                <textarea id="input-notes" oninput="triggerAutoSave()" rows="2" class="w-full border-gray-300 border rounded-md p-2 text-sm"></textarea>
                            </div>
                        </div>
                    </section>

                    <!-- 保存ボタン (SP用) -->
                    <div class="md:hidden pt-4 pb-12">
                        <button onclick="saveInvoice()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-lg">
                            <i class="fa-regular fa-floppy-disk"></i> 保存して一覧に戻る
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右側：プレビューエリア -->
            <div id="preview-area" class="flex-1 bg-gray-500 overflow-auto scroll-touch p-2 md:p-8 flex justify-center items-start print-area-wrapper relative hidden h-full">
                
                <!-- 戻るボタン (モバイル用) -->
                <button onclick="togglePreviewLayout(false)" class="md:hidden absolute top-4 left-4 z-30 bg-gray-800/80 text-white w-10 h-10 rounded-full shadow flex items-center justify-center backdrop-blur">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>

                <!-- PDFボタン (Floating) - 印刷ボタン削除 -->
                <div class="absolute top-4 right-4 z-30 flex gap-2 no-print sticky-btn">
                    <button onclick="generatePDF()" class="bg-red-600 text-white px-3 py-2 md:px-4 rounded-lg font-bold shadow hover:bg-red-700 transition flex items-center gap-2 text-sm md:text-base">
                        <i class="fa-regular fa-file-pdf"></i> <span class="hidden xs:inline">PDF保存</span><span class="xs:hidden">PDF</span>
                    </button>
                </div>

                <!-- スケーリング用ラッパー -->
                <div id="preview-scaler" class="relative transition-transform duration-200 origin-top-left shrink-0">
                    <!-- A4用紙 -->
                    <div id="invoice-preview" class="invoice-sheet print-area text-black text-sm">
                        
                        <!-- ヘッダーエリア -->
                        <div class="flex justify-between items-end border-b-2 border-indigo-900 pb-4 mb-8">
                            <h1 id="preview-title" class="text-3xl font-bold text-indigo-900 tracking-widest">請求書</h1>
                            <div class="text-right">
                                <div class="text-gray-500 text-xs">請求書番号</div>
                                <div id="preview-number" class="font-mono text-lg font-bold"></div>
                                <div class="text-gray-500 text-xs mt-1">請求日</div>
                                <div id="preview-date"></div>
                                <!-- 支払期限表示 -->
                                <div class="text-gray-500 text-xs mt-1">お支払い期限</div>
                                <div id="preview-deadline" class="font-medium"></div>
                            </div>
                        </div>

                        <!-- 宛名・差出人 -->
                        <div class="flex justify-between mb-12">
                            <div class="w-1/2 pr-4">
                                <div id="preview-client" class="text-xl font-bold border-b border-gray-400 pb-1 mb-1 inline-block min-w-[200px] min-h-[30px]"></div>
                                <span class="text-lg">御中</span>
                                <div id="preview-client-dept" class="mt-1 text-sm text-gray-600"></div>
                                
                                <div class="mt-8">
                                    <div class="text-sm inline-block">
                                        <span class="font-bold">ご請求金額</span>
                                        <!-- pb-1 を追加してアンダーバーと文字の重なりを解消 -->
                                        <span id="preview-total-highlight" class="block text-3xl font-bold border-b-2 border-black mt-1 pb-1">¥0-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="w-1/2 pl-4 text-right relative">
                                <div id="preview-my-company" class="text-lg font-bold mb-1 min-h-[28px]"></div>
                                <div id="preview-my-address" class="text-sm text-gray-600 mb-1"></div>
                                <div id="preview-my-tel" class="text-sm text-gray-600 mb-1"></div>
                                <div id="preview-my-invoice-num" class="text-xs text-gray-500 mt-2 hidden"></div>
                                
                                <!-- ハンコ -->
                                <div class="stamp-box">
                                    印
                                </div>
                            </div>
                        </div>

                        <!-- 明細テーブル -->
                        <table class="w-full mb-8 border-collapse">
                            <thead>
                                <tr class="bg-indigo-900 text-white">
                                    <th class="p-2 text-left w-5/12">内容</th>
                                    <th class="p-2 text-center w-2/12">単価</th>
                                    <th class="p-2 text-center w-1/12">数量</th>
                                    <th class="p-2 text-center w-1/12">単位</th>
                                    <th class="p-2 text-center w-1/12">税率</th>
                                    <th class="p-2 text-right w-2/12">金額</th>
                                </tr>
                            </thead>
                            <tbody id="preview-items-body"></tbody>
                        </table>

                        <!-- 計算エリア -->
                        <div class="flex justify-end mb-12">
                            <div class="w-1/2 lg:w-5/12">
                                <div class="flex justify-between border-b border-gray-300 py-1">
                                    <span>小計 (税抜)</span>
                                    <span id="preview-subtotal" class="font-mono">¥0</span>
                                </div>
                                <div id="preview-tax-breakdown"></div>
                                <div class="flex justify-between border-b border-gray-300 py-1 text-sm">
                                    <span>消費税合計</span>
                                    <span id="preview-tax-total" class="font-mono">¥0</span>
                                </div>
                                <div class="flex justify-between border-b-2 border-indigo-900 py-2 text-lg font-bold mt-2">
                                    <span>合計金額 (税込)</span>
                                    <span id="preview-grand-total" class="font-mono">¥0</span>
                                </div>
                            </div>
                        </div>

                        <!-- 備考・振込先 -->
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-bold border-b border-gray-400 mb-2 text-sm">お振込先</h4>
                                <div id="preview-bank" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600"></div>
                            </div>
                            <div>
                                <h4 class="font-bold border-b border-gray-400 mb-2 text-sm">備考</h4>
                                <div id="preview-notes" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center gap-3 z-50">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toast-message">保存しました</span>
    </div>

    <script>
        let items = [];
        let currentInvoiceId = null;
        let invoiceList = [];
        let isPreviewVisible = false;
        let autoSaveTimer = null;
        let showInvoiceNum = false;
        const STORAGE_KEY = 'easy_invoice_data_v5';
        const HISTORY_KEY_CLIENT = 'easy_invoice_client_history';
        const HISTORY_KEY_COMPANY = 'easy_invoice_my_company_history';

        document.addEventListener('DOMContentLoaded', () => {
            loadInvoices();
            showScreen('home');
            window.addEventListener('resize', () => {
                if (isPreviewVisible) adjustPreviewScale();
            });
            document.fonts.ready.then(() => console.log('Fonts loaded'));
        });

        // ==================== 履歴管理機能 ====================
        function getHistory(key) {
            return JSON.parse(localStorage.getItem(key) || '[]');
        }

        function saveHistory(key, newItem, uniqueKey = 'name') {
            if (!newItem[uniqueKey]) return;
            let history = getHistory(key);
            history = history.filter(c => c[uniqueKey] !== newItem[uniqueKey]);
            history.unshift(newItem);
            if (history.length > 20) history = history.slice(0, 20);
            localStorage.setItem(key, JSON.stringify(history));
        }

        function saveClientHistory(name, dept) {
            saveHistory(HISTORY_KEY_CLIENT, { name, dept, lastUsed: new Date().toISOString() });
        }

        function saveMyCompanyHistory(data) {
            saveHistory(HISTORY_KEY_COMPANY, { ...data, lastUsed: new Date().toISOString() });
        }

        // ==================== モーダル制御 ====================
        function toggleHistoryModal(type) {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            const title = document.getElementById('modal-title');
            
            if (type) {
                modal.classList.remove('hidden');
                let history = [];
                let renderItem = null;

                if (type === 'client') {
                    title.innerHTML = '<i class="fa-solid fa-users mr-2"></i>宛先履歴';
                    history = getHistory(HISTORY_KEY_CLIENT);
                    renderItem = (item) => `
                        <div onclick="applyClient('${item.name}', '${item.dept || ''}')" class="p-3 border-b hover:bg-blue-50 cursor-pointer flex justify-between items-center group transition">
                            <div>
                                <div class="font-bold text-gray-800">${item.name}</div>
                                ${item.dept ? `<div class="text-xs text-gray-500">${item.dept}</div>` : ''}
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-blue-400"></i>
                        </div>`;
                } else if (type === 'company') {
                    title.innerHTML = '<i class="fa-solid fa-building mr-2"></i>自社情報履歴';
                    history = getHistory(HISTORY_KEY_COMPANY);
                    renderItem = (item, index) => {
                        return `
                        <div onclick="applyCompany(${index})" class="p-3 border-b hover:bg-green-50 cursor-pointer flex justify-between items-center group transition">
                            <div>
                                <div class="font-bold text-gray-800">${item.name}</div>
                                <div class="text-xs text-gray-500 truncate max-w-[250px]">${item.address}</div>
                                <div class="text-[10px] text-gray-400 mt-1">銀行: ${item.bank ? item.bank.substring(0, 15) + '...' : '(なし)'}</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-green-400"></i>
                        </div>`;
                    };
                }
                
                if (history.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">履歴はありません。<br>請求書を保存すると自動的に追加されます。</div>';
                } else {
                    list.innerHTML = history.map((item, idx) => renderItem(item, idx)).join('');
                }
            } else {
                modal.classList.add('hidden');
            }
        }

        function applyClient(name, dept) {
            document.getElementById('input-client').value = name;
            document.getElementById('input-client-dept').value = dept;
            toggleHistoryModal(false);
            triggerAutoSave();
        }

        function applyCompany(index) {
            const history = getHistory(HISTORY_KEY_COMPANY);
            const data = history[index];
            if (!data) return;

            document.getElementById('input-my-company').value = data.name || '';
            document.getElementById('input-my-address').value = data.address || '';
            document.getElementById('input-my-tel').value = data.tel || '';
            document.getElementById('input-my-invoice-num').value = data.invoiceNum || '';
            document.getElementById('input-bank').value = data.bank || '';
            
            if (data.invoiceNum) {
                document.getElementById('toggle-invoice-num').checked = true;
                toggleInvoiceNum();
            }

            toggleHistoryModal(false);
            triggerAutoSave();
        }

        // ==================== インボイス番号切替機能 ====================
        function toggleInvoiceNum() {
            const checkbox = document.getElementById('toggle-invoice-num');
            const container = document.getElementById('invoice-num-container');
            showInvoiceNum = checkbox.checked;

            if (showInvoiceNum) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            triggerAutoSave();
            updatePreview();
        }

        // ==================== PDF生成機能 (精密版: 白紙対策済) ====================
        async function generatePDF() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('active');
            await new Promise(resolve => setTimeout(resolve, 200));

            try {
                const originalElement = document.getElementById('invoice-preview');
                const clone = originalElement.cloneNode(true);
                
                const container = document.createElement('div');
                Object.assign(container.style, {
                    position: 'fixed', top: '0', left: '0', zIndex: '-9999',
                    width: '210mm', height: 'auto', minHeight: '297mm',
                    overflow: 'hidden', backgroundColor: '#ffffff' 
                });
                
                clone.style.transform = 'none';
                clone.style.margin = '0';
                clone.style.boxShadow = 'none'; 
                
                container.appendChild(clone);
                document.body.appendChild(container);

                const scale = 3; 

                const canvas = await html2canvas(container, {
                    scale: scale,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    windowWidth: container.offsetWidth,
                    scrollX: 0,
                    scrollY: 0,
                    onclone: (doc) => {}
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                document.body.removeChild(container);

                const filename = `請求書_${document.getElementById('input-number').value || 'INV'}.pdf`;
                pdf.save(filename);
                showToast("PDFをダウンロードしました");

            } catch (error) {
                console.error("PDF Error:", error);
                alert("PDF生成エラー: " + error.message);
            } finally {
                overlay.classList.remove('active');
            }
        }

        // ==================== プレビュー自動縮小ロジック ====================
        function adjustPreviewScale() {
            const previewArea = document.getElementById('preview-area');
            const invoice = document.getElementById('invoice-preview');
            const scaler = document.getElementById('preview-scaler');
            if (!previewArea || !invoice || !scaler) return;

            // コンテナ幅が取得できない場合（非表示中など）は処理しない
            if (previewArea.clientWidth === 0) return;

            const containerWidth = previewArea.clientWidth - 32; // 余白を引く
            const invoiceWidth = 794; // A4 px

            if (containerWidth < invoiceWidth) {
                const scale = containerWidth / invoiceWidth;
                invoice.style.transform = `scale(${scale})`;
                scaler.style.width = `${invoiceWidth * scale}px`;
                scaler.style.height = `${invoice.offsetHeight * scale}px`;
            } else {
                invoice.style.transform = 'none';
                scaler.style.width = 'auto';
                scaler.style.height = 'auto';
            }
        }

        function triggerAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => saveInvoice(true), 1000);
        }

        // ==================== 画面遷移 ====================
        function showScreen(screenId) {
            const home = document.getElementById('screen-home');
            const editor = document.getElementById('screen-editor');
            const hActions = document.getElementById('header-actions-home');
            const eActions = document.getElementById('header-actions-editor');

            if (screenId === 'home') {
                home.classList.remove('hidden');
                editor.classList.add('hidden');
                hActions.classList.remove('hidden');
                eActions.classList.add('hidden');
                loadInvoices();
            } else {
                home.classList.add('hidden');
                editor.classList.remove('hidden');
                hActions.classList.add('hidden');
                eActions.classList.remove('hidden');
            }
        }

        // ==================== レイアウト制御 (完全修正版) ====================
        function togglePreviewLayout(show) {
            const screenEditor = document.getElementById('screen-editor');
            const editorArea = document.getElementById('editor-area');
            const previewArea = document.getElementById('preview-area');
            const isMobile = window.innerWidth < 768; // Tailwind md breakpoint

            isPreviewVisible = show;

            if (!show) {
                // ■ 編集モード
                
                screenEditor.classList.remove('md:flex-row', 'items-start');
                screenEditor.classList.add('items-center', 'justify-center');

                // エディタを必ず表示
                editorArea.classList.remove('hidden');
                
                // 集中モードスタイル
                editorArea.className = "w-full md:max-w-3xl bg-white md:shadow-2xl md:rounded-xl md:border md:border-gray-200 overflow-y-auto p-4 md:p-6 no-print pb-32 md:pb-24 custom-scrollbar z-20 h-full md:h-[90vh]";

                // プレビューを必ず隠す
                previewArea.classList.add('hidden');
                
            } else {
                // ■ プレビューモード
                
                screenEditor.classList.remove('items-center', 'justify-center');
                screenEditor.classList.add('md:flex-row', 'items-start');

                if (isMobile) {
                    // モバイル: エディタを隠してプレビューのみ表示 (排他制御)
                    editorArea.classList.add('hidden');
                    previewArea.classList.remove('hidden');
                } else {
                    // PC: 両方表示
                    editorArea.classList.remove('hidden');
                    previewArea.classList.remove('hidden');
                    
                    // 2カラムスタイル
                    editorArea.className = "w-full md:w-5/12 lg:w-4/12 bg-white border-r border-gray-200 overflow-y-auto p-4 sm:p-6 no-print pb-24 shadow-inner custom-scrollbar z-20 h-full";
                }

                // 表示後にサイズ計算（少し遅延させて確実に行う）
                setTimeout(adjustPreviewScale, 300);
            }
        }

        // ==================== データ管理 ====================
        function loadInvoices() {
            const data = localStorage.getItem(STORAGE_KEY);
            invoiceList = data ? JSON.parse(data) : [];
            renderInvoiceList();
        }

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(invoiceList));
        }

        function createNewInvoice() {
            currentInvoiceId = Date.now().toString();
            clearForm();
            items = [{ id: Date.now(), name: "", price: 0, qty: 1, unit: "式", taxRate: 10, taxAmount: 0 }];
            
            document.getElementById('toggle-invoice-num').checked = false;
            
            const companyHistory = getHistory(HISTORY_KEY_COMPANY);
            if (companyHistory.length > 0) {
                const latest = companyHistory[0];
                document.getElementById('input-my-company').value = latest.name || '';
                document.getElementById('input-my-address').value = latest.address || '';
                document.getElementById('input-my-tel').value = latest.tel || '';
                document.getElementById('input-my-invoice-num').value = latest.invoiceNum || '';
                document.getElementById('input-bank').value = latest.bank || '';
                
                if (latest.invoiceNum) {
                    document.getElementById('toggle-invoice-num').checked = true;
                }
            }
            
            toggleInvoiceNum();
            renderItems();
            togglePreviewLayout(false);
            showScreen('editor');
        }

        function editInvoice(id) {
            const invoice = invoiceList.find(v => v.id === id);
            if (!invoice) return;

            currentInvoiceId = invoice.id;
            
            document.getElementById('input-title').value = invoice.title || '';
            document.getElementById('input-number').value = invoice.number || '';
            document.getElementById('input-date').value = invoice.date || '';
            document.getElementById('input-deadline').value = invoice.deadline || '';
            document.getElementById('input-client').value = invoice.client || '';
            document.getElementById('input-client-dept').value = invoice.clientDept || '';
            document.getElementById('input-my-company').value = invoice.myCompany || '';
            document.getElementById('input-my-address').value = invoice.myAddress || '';
            document.getElementById('input-my-tel').value = invoice.myTel || '';
            document.getElementById('input-my-invoice-num').value = invoice.myInvoiceNum || '';
            document.getElementById('input-bank').value = invoice.bank || '';
            document.getElementById('input-notes').value = invoice.notes || '';

            const hasNum = !!invoice.myInvoiceNum;
            const savedState = invoice.showInvoiceNum !== undefined ? invoice.showInvoiceNum : hasNum;
            
            document.getElementById('toggle-invoice-num').checked = savedState;
            toggleInvoiceNum();

            items = (invoice.items || []).map(item => {
                let newItem = { ...item };
                if (newItem.taxRate < 1 && newItem.taxRate > 0) newItem.taxRate *= 100;
                if (newItem.taxAmount === undefined) newItem.taxAmount = Math.floor((newItem.price * newItem.qty) * (newItem.taxRate / 100));
                return newItem;
            });

            renderItems();
            togglePreviewLayout(false);
            showScreen('editor');
        }

        function saveInvoice(isAutoSave = false) {
            let title = document.getElementById('input-title').value;
            if(!title.trim()) {
                title = "名称未設定の請求書";
                if(!isAutoSave) document.getElementById('input-title').value = title;
            }

            const clientName = document.getElementById('input-client').value;
            if (clientName) {
                saveClientHistory(clientName, document.getElementById('input-client-dept').value);
            }
            
            const myName = document.getElementById('input-my-company').value;
            if (myName) {
                saveMyCompanyHistory({
                    name: myName,
                    address: document.getElementById('input-my-address').value,
                    tel: document.getElementById('input-my-tel').value,
                    invoiceNum: document.getElementById('input-my-invoice-num').value,
                    bank: document.getElementById('input-bank').value
                });
            }

            const data = {
                id: currentInvoiceId,
                updatedAt: new Date().toISOString(),
                title: title,
                number: document.getElementById('input-number').value,
                date: document.getElementById('input-date').value,
                deadline: document.getElementById('input-deadline').value,
                client: clientName,
                clientDept: document.getElementById('input-client-dept').value,
                myCompany: document.getElementById('input-my-company').value,
                myAddress: document.getElementById('input-my-address').value,
                myTel: document.getElementById('input-my-tel').value,
                myInvoiceNum: document.getElementById('input-my-invoice-num').value,
                showInvoiceNum: showInvoiceNum,
                bank: document.getElementById('input-bank').value,
                notes: document.getElementById('input-notes').value,
                items: items,
                total: calculateTotal()
            };

            const index = invoiceList.findIndex(v => v.id === currentInvoiceId);
            if (index >= 0) invoiceList[index] = data;
            else invoiceList.unshift(data);

            saveToStorage();
            
            const statusEl = document.getElementById('save-status');
            if(statusEl) {
                statusEl.classList.remove('hidden', 'scale-0');
                setTimeout(() => statusEl.classList.add('scale-0'), 2000);
            }

            if(!isAutoSave) showToast("保存しました");
        }

        function deleteInvoice(id, event) {
            event.stopPropagation();
            if(!confirm('削除しますか？')) return;
            invoiceList = invoiceList.filter(v => v.id !== id);
            saveToStorage();
            renderInvoiceList();
            showToast("削除しました");
        }

        function renderInvoiceList() {
            const container = document.getElementById('invoice-list');
            document.getElementById('invoice-count').innerText = `${invoiceList.length}件`;

            if (invoiceList.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-20 text-gray-400">
                        <i class="fa-regular fa-folder-open text-5xl mb-4"></i>
                        <p>請求書はありません</p>
                        <button onclick="createNewInvoice()" class="mt-4 text-indigo-600 font-bold hover:underline">新規作成</button>
                    </div>`;
                return;
            }

            container.innerHTML = invoiceList.map(inv => `
                <div onclick="editInvoice('${inv.id}')" class="bg-white p-4 md:p-5 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition cursor-pointer relative group">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-base md:text-lg text-indigo-900 truncate pr-8">${inv.title}</h3>
                        <button onclick="deleteInvoice('${inv.id}', event)" class="text-gray-400 hover:text-red-500 transition px-2 py-1">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                    <div class="text-xs md:text-sm text-gray-600 mb-3">
                        <p class="truncate"><i class="fa-regular fa-building mr-1"></i> ${inv.client || '宛名なし'}</p>
                        <p class="text-xs text-gray-400 mt-1">${inv.date ? formatDate(inv.date) : '日付なし'}</p>
                    </div>
                    <div class="flex justify-between items-end border-t pt-2">
                        <span class="text-xs text-gray-400">税込合計</span>
                        <span class="text-lg md:text-xl font-bold text-gray-800">¥${(inv.total || 0).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // ==================== 編集・入力機能 ====================
        function clearForm() {
            document.querySelectorAll('input, textarea').forEach(input => input.value = '');
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-3 border rounded shadow-sm relative group";
                
                div.innerHTML = `
                    <button onclick="removeItem(${index})" class="absolute -right-2 -top-2 bg-red-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow hover:bg-red-500 z-10 transition-colors">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <div class="grid grid-cols-12 gap-2 items-end">
                        <div class="col-span-12 md:col-span-4">
                            <label class="text-xs text-gray-500 block">内容</label>
                            <input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)" class="w-full border p-1.5 rounded text-sm bg-white">
                        </div>
                        <div class="col-span-4 md:col-span-2">
                            <label class="text-xs text-gray-500 block">単価</label>
                            <input type="number" value="${item.price}" onchange="updateItem(${index}, 'price', this.value)" class="w-full border p-1.5 rounded text-sm text-right bg-white">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="text-xs text-gray-500 block">数量</label>
                            <input type="number" value="${item.qty}" onchange="updateItem(${index}, 'qty', this.value)" class="w-full border p-1.5 rounded text-sm text-right bg-white">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="text-xs text-gray-500 block">単位</label>
                            <input type="text" value="${item.unit}" onchange="updateItem(${index}, 'unit', this.value)" class="w-full border p-1.5 rounded text-sm text-center bg-white">
                        </div>
                        <div class="col-span-4 md:col-span-2">
                            <label class="text-xs text-gray-500 block">税率/税額</label>
                            <div class="flex flex-col gap-1">
                                <div class="relative">
                                    <select onchange="updateItem(${index}, 'taxRate', this.value)" class="w-full border p-1 rounded text-xs text-right bg-white pr-1 appearance-none">
                                        <option value="10" ${item.taxRate === 10 ? 'selected' : ''}>10%</option>
                                        <option value="8" ${item.taxRate === 8 ? 'selected' : ''}>8% (軽減)</option>
                                        <option value="0" ${item.taxRate === 0 ? 'selected' : ''}>非課税</option>
                                    </select>
                                    <span class="absolute right-4 top-1.5 text-[10px] text-gray-400 pointer-events-none">▼</span>
                                </div>
                                <div class="relative">
                                    <input type="number" value="${item.taxAmount}" onchange="updateItem(${index}, 'taxAmount', this.value)" class="w-full border p-1 rounded text-xs text-right bg-white text-indigo-700 font-medium pr-5" placeholder="額">
                                    <span class="absolute right-1 top-1 text-[10px] text-gray-400">円</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-12 md:col-span-2">
                            <label class="text-xs text-gray-500 block">金額(税込)</label>
                            <input type="text" value="¥${((item.price * item.qty) + item.taxAmount).toLocaleString()}" readonly class="w-full border p-1.5 rounded text-sm text-right bg-gray-100 text-gray-500">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateItem(index, field, value) {
            let val = parseFloat(value);
            if (isNaN(val) && field !== 'name' && field !== 'unit') val = 0;
            if (field !== 'name' && field !== 'unit') items[index][field] = val;
            else items[index][field] = value;

            if (field === 'price' || field === 'qty' || field === 'taxRate') {
                const subtotal = items[index].price * items[index].qty;
                items[index].taxAmount = Math.floor(subtotal * (items[index].taxRate / 100));
            }
            renderItems();
            triggerAutoSave();
        }

        function addItem() {
            items.push({ id: Date.now(), name: "", price: 0, qty: 1, unit: "式", taxRate: 10, taxAmount: 0 });
            renderItems();
            triggerAutoSave();
        }

        function removeItem(index) {
            items.splice(index, 1);
            renderItems();
            triggerAutoSave();
        }

        // ==================== プレビュー & 計算 ====================
        function calculateTotal() {
            let total = 0;
            items.forEach(item => total += (item.price * item.qty) + item.taxAmount);
            return total;
        }

        function updatePreview(showLayout = false) {
            if (showLayout && !isPreviewVisible) togglePreviewLayout(true);

            setText('preview-title', document.getElementById('input-title').value);
            setText('preview-number', document.getElementById('input-number').value);
            setText('preview-date', formatDate(document.getElementById('input-date').value));
            
            // Set Deadline
            const deadline = document.getElementById('input-deadline').value;
            const previewDeadline = document.getElementById('preview-deadline');
            const previewDeadlineContainer = previewDeadline.previousElementSibling; 
            
            if (deadline) {
                previewDeadline.innerText = deadline;
                previewDeadline.classList.remove('hidden');
                if(previewDeadlineContainer) previewDeadlineContainer.classList.remove('hidden');
            } else {
                previewDeadline.classList.add('hidden');
                if(previewDeadlineContainer) previewDeadlineContainer.classList.add('hidden');
            }

            setText('preview-client', document.getElementById('input-client').value);
            setText('preview-client-dept', document.getElementById('input-client-dept').value);
            setText('preview-my-company', document.getElementById('input-my-company').value);
            setText('preview-my-address', document.getElementById('input-my-address').value);
            setText('preview-my-tel', document.getElementById('input-my-tel').value);
            
            const invoiceNum = document.getElementById('input-my-invoice-num').value;
            const previewInvoiceNum = document.getElementById('preview-my-invoice-num');
            if (showInvoiceNum && invoiceNum) {
                previewInvoiceNum.innerText = invoiceNum;
                previewInvoiceNum.classList.remove('hidden');
            } else {
                previewInvoiceNum.classList.add('hidden');
            }

            setText('preview-bank', document.getElementById('input-bank').value);
            setText('preview-notes', document.getElementById('input-notes').value);

            const tbody = document.getElementById('preview-items-body');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            let taxBreakdown = {};

            items.forEach(item => {
                const rowPrice = item.price * item.qty;
                subtotal += rowPrice;
                const rateKey = item.taxRate;
                if (!taxBreakdown[rateKey]) taxBreakdown[rateKey] = { taxable: 0, tax: 0 };
                taxBreakdown[rateKey].taxable += rowPrice;
                taxBreakdown[rateKey].tax += item.taxAmount;

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200";
                tr.innerHTML = `
                    <td class="p-2 text-left">${item.name}</td>
                    <td class="p-2 text-center">¥${item.price.toLocaleString()}</td>
                    <td class="p-2 text-center">${item.qty}</td>
                    <td class="p-2 text-center">${item.unit}</td>
                    <td class="p-2 text-center text-xs text-gray-500">${item.taxRate === 0 ? '非' : item.taxRate + '%'}</td>
                    <td class="p-2 text-right font-mono">¥${rowPrice.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });

            let totalTax = 0;
            const breakdownContainer = document.getElementById('preview-tax-breakdown');
            breakdownContainer.innerHTML = '';

            Object.keys(taxBreakdown).sort((a, b) => b - a).forEach(rate => {
                // 非課税でも金額があれば表示する場合はここを調整
                if (parseFloat(rate) === 0) return; // 今回は0%の内訳は出さない
                const data = taxBreakdown[rate];
                totalTax += data.tax;
                const div = document.createElement('div');
                div.className = "flex justify-between border-b border-gray-300 py-1 text-xs text-gray-500";
                div.innerHTML = `<span>(内 ${rate}%対象 ¥${data.taxable.toLocaleString()}) 消費税</span><span class="font-mono">¥${data.tax.toLocaleString()}</span>`;
                breakdownContainer.appendChild(div);
            });

            const grandTotal = subtotal + totalTax;
            setText('preview-subtotal', `¥${subtotal.toLocaleString()}`);
            setText('preview-tax-total', `¥${totalTax.toLocaleString()}`);
            setText('preview-grand-total', `¥${grandTotal.toLocaleString()}`);
            setText('preview-total-highlight', `¥${grandTotal.toLocaleString()}-`);

            if(isPreviewVisible) adjustPreviewScale();
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if(el) el.innerText = value;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('translate-y-20');
            setTimeout(() => toast.classList.add('translate-y-20'), 3000);
        }
    </script>
</body>
</html>

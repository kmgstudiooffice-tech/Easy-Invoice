<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Invoice - 自動請求書作成</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }

        /* 印刷時のスタイル */
        @media print {
            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .print-area {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            /* A4縦の余白調整 */
            @page {
                margin: 0;
                size: A4;
            }
            .invoice-sheet {
                margin: 0;
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                page-break-after: always;
            }
        }

        .invoice-sheet {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
        }

        /* ハンコ風スタイル */
        .stamp-box {
            width: 60px;
            height: 60px;
            border: 2px solid #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            font-weight: bold;
            font-size: 14px;
            transform: rotate(-15deg);
            opacity: 0.8;
            position: absolute;
            right: 10px;
            bottom: 10px;
            pointer-events: none;
        }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden">

    <!-- ヘッダー -->
    <header class="bg-indigo-600 text-white p-4 shadow-md z-10 no-print flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-file-invoice text-2xl"></i>
            <h1 class="text-xl font-bold">Easy Invoice Generator</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex bg-indigo-800 rounded-lg p-1">
                <button onclick="setMode('simple')" id="btn-simple" class="px-4 py-1.5 rounded-md text-sm font-medium transition-colors bg-white text-indigo-900 shadow-sm">簡易モード</button>
                <button onclick="setMode('detail')" id="btn-detail" class="px-4 py-1.5 rounded-md text-sm font-medium transition-colors text-indigo-100 hover:text-white">詳細モード</button>
            </div>
            <button onclick="window.print()" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-bold hover:bg-indigo-50 transition shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-print"></i> 印刷・PDF保存
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- 左側：入力フォーム (スクロール可能) -->
        <div class="w-full md:w-5/12 lg:w-4/12 bg-white border-r border-gray-200 overflow-y-auto p-6 no-print pb-24 shadow-inner custom-scrollbar">
            
            <div class="space-y-6">
                <!-- 基本情報 -->
                <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">基本情報</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">件名 (タイトル)</label>
                            <input type="text" id="input-title" value="請求書" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" oninput="updatePreview()">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">請求日</label>
                                <input type="date" id="input-date" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500" oninput="updatePreview()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">請求書番号</label>
                                <input type="text" id="input-number" value="INV-2023001" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500" oninput="updatePreview()">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 取引先・自社情報 -->
                <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">取引先・自社情報</h3>
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                            <label class="block text-xs font-bold text-blue-800 mb-1">請求先 (宛名)</label>
                            <input type="text" id="input-client" value="株式会社 クライアント" class="w-full border-gray-300 border rounded-md p-2 mb-2" oninput="updatePreview()">
                            <input type="text" id="input-client-dept" placeholder="部署・担当者名 (任意)" class="w-full border-gray-300 border rounded-md p-2 text-sm detail-only hidden" oninput="updatePreview()">
                        </div>

                        <div class="bg-green-50 p-3 rounded-md border border-green-100">
                            <label class="block text-xs font-bold text-green-800 mb-1">請求元 (自社)</label>
                            <input type="text" id="input-my-company" value="株式会社 サンプルデザイン" class="w-full border-gray-300 border rounded-md p-2 mb-2" oninput="updatePreview()">
                            <input type="text" id="input-my-address" value="〒100-0001 東京都千代田区1-1-1" class="w-full border-gray-300 border rounded-md p-2 text-sm mb-2" oninput="updatePreview()">
                            <div class="detail-only hidden">
                                <input type="text" id="input-my-tel" value="TEL: 03-1234-5678" class="w-full border-gray-300 border rounded-md p-2 text-sm mb-2" oninput="updatePreview()">
                                <input type="text" id="input-my-invoice-num" placeholder="登録番号 T1234..." class="w-full border-gray-300 border rounded-md p-2 text-sm" oninput="updatePreview()">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 備考・振込先 (詳細モードのみ) -->
                <section class="detail-only hidden transition-all duration-300">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">振込先・備考</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">振込先銀行</label>
                            <textarea id="input-bank" rows="3" class="w-full border-gray-300 border rounded-md p-2 text-sm" oninput="updatePreview()">銀行名: サンプル銀行
支店名: 本店営業部 (001)
口座: 普通 1234567
名義: カ) サンプルデザイン</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">備考</label>
                            <textarea id="input-notes" rows="2" class="w-full border-gray-300 border rounded-md p-2 text-sm" oninput="updatePreview()">振込手数料は貴社にてご負担願います。</textarea>
                        </div>
                    </div>
                </section>

                <!-- 品目リスト -->
                <section>
                    <div class="flex justify-between items-center mb-3 border-b pb-1">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">請求項目</h3>
                        <button onclick="addItem()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 font-bold"><i class="fa-solid fa-plus"></i> 追加</button>
                    </div>
                    
                    <div id="items-container" class="space-y-3">
                        <!-- JSで項目が追加されます -->
                    </div>
                </section>
            </div>
        </div>

        <!-- 右側：プレビューエリア (スクロール可能) -->
        <div class="flex-1 bg-gray-500 overflow-auto p-4 md:p-8 flex justify-center items-start print-area-wrapper">
            <!-- A4用紙 -->
            <div id="invoice-preview" class="invoice-sheet print-area text-black text-sm">
                
                <!-- ヘッダーエリア -->
                <div class="flex justify-between items-end border-b-2 border-indigo-900 pb-4 mb-8">
                    <h1 id="preview-title" class="text-3xl font-bold text-indigo-900 tracking-widest">請求書</h1>
                    <div class="text-right">
                        <div class="text-gray-500 text-xs">請求書番号</div>
                        <div id="preview-number" class="font-mono text-lg font-bold">INV-000000</div>
                        <div class="text-gray-500 text-xs mt-1">請求日</div>
                        <div id="preview-date">2023年1月1日</div>
                    </div>
                </div>

                <!-- 宛名・差出人 -->
                <div class="flex justify-between mb-12">
                    <div class="w-1/2 pr-4">
                        <div id="preview-client" class="text-xl font-bold border-b border-gray-400 pb-1 mb-1 inline-block min-w-[200px]">株式会社 クライアント</div>
                        <span class="text-lg">御中</span>
                        <div id="preview-client-dept" class="mt-1 text-sm text-gray-600"></div>
                        
                        <div class="mt-8">
                            <div class="text-sm bg-gray-100 p-2 inline-block rounded">
                                <span class="font-bold">ご請求金額</span>
                                <span id="preview-total-highlight" class="block text-3xl font-bold border-b-2 border-black mt-1">¥0-</span>
                            </div>
                        </div>
                    </div>

                    <div class="w-1/2 pl-4 text-right relative">
                        <div id="preview-my-company" class="text-lg font-bold mb-1">株式会社 サンプルデザイン</div>
                        <div id="preview-my-address" class="text-sm text-gray-600 mb-1"></div>
                        <div id="preview-my-tel" class="text-sm text-gray-600 mb-1"></div>
                        <div id="preview-my-invoice-num" class="text-xs text-gray-500 mt-2"></div>
                        
                        <!-- ハンコ -->
                        <div class="stamp-box">
                            検印
                        </div>
                    </div>
                </div>

                <!-- 明細テーブル -->
                <table class="w-full mb-8 border-collapse">
                    <thead>
                        <tr class="bg-indigo-900 text-white">
                            <th class="p-2 text-left w-1/2">内容</th>
                            <th class="p-2 text-center w-16 detail-col">単価</th>
                            <th class="p-2 text-center w-16 detail-col">数量</th>
                            <th class="p-2 text-center w-12 detail-col">単位</th>
                            <th class="p-2 text-right w-24">金額</th>
                        </tr>
                    </thead>
                    <tbody id="preview-items-body">
                        <!-- JSで生成 -->
                    </tbody>
                </table>

                <!-- 計算エリア -->
                <div class="flex justify-end mb-12">
                    <div class="w-1/2 lg:w-1/3">
                        <div class="flex justify-between border-b border-gray-300 py-1">
                            <span>小計 (税抜)</span>
                            <span id="preview-subtotal" class="font-mono">¥0</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-300 py-1 text-xs text-gray-500 detail-col">
                            <span>(内 10%対象)</span>
                            <span id="preview-taxable-10" class="font-mono">¥0</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-300 py-1 text-xs text-gray-500 detail-col">
                            <span>(内 8%対象)</span>
                            <span id="preview-taxable-8" class="font-mono">¥0</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-300 py-1 text-sm">
                            <span>消費税</span>
                            <span id="preview-tax-total" class="font-mono">¥0</span>
                        </div>
                        <div class="flex justify-between border-b-2 border-indigo-900 py-2 text-lg font-bold mt-2">
                            <span>合計金額 (税込)</span>
                            <span id="preview-grand-total" class="font-mono">¥0</span>
                        </div>
                    </div>
                </div>

                <!-- 備考・振込先 -->
                <div class="grid grid-cols-2 gap-8 detail-only hidden">
                    <div>
                        <h4 class="font-bold border-b border-gray-400 mb-2 text-sm">お振込先</h4>
                        <div id="preview-bank" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600"></div>
                    </div>
                    <div>
                        <h4 class="font-bold border-b border-gray-400 mb-2 text-sm">備考</h4>
                        <div id="preview-notes" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // 状態管理
        let currentMode = 'simple';
        let items = [
            { id: 1, name: "Webサイト制作費", price: 150000, qty: 1, unit: "式", taxRate: 0.10 },
            { id: 2, name: "サーバー初期設定", price: 30000, qty: 1, unit: "式", taxRate: 0.10 }
        ];

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
            renderItems();
            updatePreview();
            setMode('simple'); // デフォルトは簡易モード
        });

        // モード切替
        function setMode(mode) {
            currentMode = mode;
            const btnSimple = document.getElementById('btn-simple');
            const btnDetail = document.getElementById('btn-detail');
            const detailElements = document.querySelectorAll('.detail-only');
            const detailCols = document.querySelectorAll('.detail-col');

            if (mode === 'simple') {
                // UI切り替え
                btnSimple.className = "px-4 py-1.5 rounded-md text-sm font-medium transition-colors bg-white text-indigo-900 shadow-sm";
                btnDetail.className = "px-4 py-1.5 rounded-md text-sm font-medium transition-colors text-indigo-100 hover:text-white";
                
                // 要素の表示/非表示
                detailElements.forEach(el => el.classList.add('hidden'));
                detailCols.forEach(el => el.classList.add('hidden'));
            } else {
                btnSimple.className = "px-4 py-1.5 rounded-md text-sm font-medium transition-colors text-indigo-100 hover:text-white";
                btnDetail.className = "px-4 py-1.5 rounded-md text-sm font-medium transition-colors bg-white text-indigo-900 shadow-sm";

                detailElements.forEach(el => el.classList.remove('hidden'));
                detailCols.forEach(el => el.classList.remove('hidden'));
            }
            renderItems(); // 入力フォームを再描画
            updatePreview(); // プレビューを再描画
        }

        // 項目レンダリング（入力フォーム）
        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "bg-white p-3 border rounded shadow-sm relative group";
                
                // 削除ボタン
                div.innerHTML = `
                    <button onclick="removeItem(${index})" class="absolute -right-2 -top-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow hover:bg-red-600 z-10">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <div class="grid ${currentMode === 'simple' ? 'grid-cols-3' : 'grid-cols-12'} gap-2 items-end">
                        <div class="${currentMode === 'simple' ? 'col-span-2' : 'col-span-4'}">
                            <label class="text-xs text-gray-500 block">内容</label>
                            <input type="text" value="${item.name}" oninput="updateItem(${index}, 'name', this.value)" class="w-full border p-1 rounded text-sm">
                        </div>
                        
                        <div class="${currentMode === 'simple' ? 'hidden' : 'col-span-2 block'}">
                            <label class="text-xs text-gray-500 block">単価</label>
                            <input type="number" value="${item.price}" oninput="updateItem(${index}, 'price', this.value)" class="w-full border p-1 rounded text-sm text-right">
                        </div>

                        <div class="${currentMode === 'simple' ? 'hidden' : 'col-span-2 block'}">
                            <label class="text-xs text-gray-500 block">数量</label>
                            <input type="number" value="${item.qty}" oninput="updateItem(${index}, 'qty', this.value)" class="w-full border p-1 rounded text-sm text-right">
                        </div>

                        <div class="${currentMode === 'simple' ? 'hidden' : 'col-span-1 block'}">
                            <label class="text-xs text-gray-500 block">単位</label>
                            <input type="text" value="${item.unit}" oninput="updateItem(${index}, 'unit', this.value)" class="w-full border p-1 rounded text-sm text-center">
                        </div>

                        <div class="${currentMode === 'simple' ? 'col-span-1' : 'col-span-3'}">
                            <label class="text-xs text-gray-500 block">金額(税込/税抜)</label>
                            <!-- 簡易モードではこれが金額そのもの、詳細モードでは自動計算結果だが上書きも可能にするため単価と連動 -->
                            <input type="number" value="${currentMode === 'simple' ? item.price : (item.price * item.qty)}" 
                                   oninput="${currentMode === 'simple' ? `updateItem(${index}, 'price', this.value)` : ''}" 
                                   ${currentMode === 'detail' ? 'readonly' : ''}
                                   class="w-full border p-1 rounded text-sm text-right ${currentMode === 'detail' ? 'bg-gray-100 text-gray-500' : ''}">
                        </div>
                    </div>
                    
                    <div class="${currentMode === 'simple' ? 'hidden' : 'mt-2 flex items-center gap-4 text-xs'}">
                         <label class="flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="tax-${index}" ${item.taxRate === 0.1 ? 'checked' : ''} onchange="updateItem(${index}, 'taxRate', 0.1)">
                            10%
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="tax-${index}" ${item.taxRate === 0.08 ? 'checked' : ''} onchange="updateItem(${index}, 'taxRate', 0.08)">
                            8%(軽減)
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // データ更新処理
        function updateItem(index, field, value) {
            if (field === 'price' || field === 'qty') {
                items[index][field] = parseFloat(value) || 0;
            } else if (field === 'taxRate') {
                items[index][field] = parseFloat(value);
            } else {
                items[index][field] = value;
            }
            renderItems(); // inputのフォーカスが外れる可能性があるため、最適化の余地ありだが簡単のため再描画
            // 再描画するとフォーカスが外れる問題の対策：本来はDOM操作だけで値を更新するが、ここでは簡易実装として
            // inputにフォーカスを戻す処理は省略。実運用ではVue/React推奨。
            
            // 簡易的な回避：renderItemsを呼ばず計算だけ走らせるupdatePreviewを呼ぶ
            // ただし、計算結果表示(readonlyのinput)を更新する必要があるため、今回は
            // oninputでupdatePreviewだけ呼び、DOM再構築はaddItem/removeItemのみにする設計に寄せたほうがUXが良い。
            // 今回はコードの短さを優先し、renderItemsを呼ぶ頻度を下げる工夫は割愛。
            updatePreview();
        }

        function addItem() {
            items.push({ id: Date.now(), name: "", price: 0, qty: 1, unit: "式", taxRate: 0.10 });
            renderItems();
            updatePreview();
        }

        function removeItem(index) {
            items.splice(index, 1);
            renderItems();
            updatePreview();
        }

        // プレビュー更新＆計算ロジック
        function updatePreview() {
            // テキスト反映
            setText('preview-title', document.getElementById('input-title').value);
            setText('preview-number', document.getElementById('input-number').value);
            setText('preview-date', formatDate(document.getElementById('input-date').value));
            
            setText('preview-client', document.getElementById('input-client').value);
            setText('preview-client-dept', document.getElementById('input-client-dept').value);
            
            setText('preview-my-company', document.getElementById('input-my-company').value);
            setText('preview-my-address', document.getElementById('input-my-address').value);
            setText('preview-my-tel', document.getElementById('input-my-tel').value);
            setText('preview-my-invoice-num', document.getElementById('input-my-invoice-num').value);

            setText('preview-bank', document.getElementById('input-bank').value);
            setText('preview-notes', document.getElementById('input-notes').value);

            // テーブル行生成
            const tbody = document.getElementById('preview-items-body');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            let taxable10 = 0;
            let taxable8 = 0;
            let taxTotal = 0;

            items.forEach(item => {
                const rowTotal = item.price * item.qty;
                subtotal += rowTotal;
                
                if (item.taxRate === 0.10) taxable10 += rowTotal;
                if (item.taxRate === 0.08) taxable8 += rowTotal;

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200";
                
                // 表示制御
                const showDetail = currentMode === 'detail';
                const taxMark = (showDetail && item.taxRate === 0.08) ? '<span class="text-xs bg-gray-200 px-1 rounded ml-1">※</span>' : '';

                tr.innerHTML = `
                    <td class="p-2 text-left">${item.name} ${taxMark}</td>
                    <td class="p-2 text-center detail-col ${!showDetail ? 'hidden' : ''}">¥${item.price.toLocaleString()}</td>
                    <td class="p-2 text-center detail-col ${!showDetail ? 'hidden' : ''}">${item.qty}</td>
                    <td class="p-2 text-center detail-col ${!showDetail ? 'hidden' : ''}">${item.unit}</td>
                    <td class="p-2 text-right font-mono">¥${rowTotal.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });

            // 税計算（端数処理：切り捨て）
            const tax10 = Math.floor(taxable10 * 0.10);
            const tax8 = Math.floor(taxable8 * 0.08);
            taxTotal = tax10 + tax8;
            const grandTotal = subtotal + taxTotal;

            // 金額反映
            setText('preview-subtotal', `¥${subtotal.toLocaleString()}`);
            setText('preview-taxable-10', `¥${taxable10.toLocaleString()}`);
            setText('preview-taxable-8', `¥${taxable8.toLocaleString()}`);
            setText('preview-tax-total', `¥${taxTotal.toLocaleString()}`);
            setText('preview-grand-total', `¥${grandTotal.toLocaleString()}`);
            setText('preview-total-highlight', `¥${grandTotal.toLocaleString()}-`);

            // モードによるCSS制御（詳細項目の表示切替）
            const detailCols = document.querySelectorAll('.detail-col');
            if(currentMode === 'simple') {
                detailCols.forEach(el => el.classList.add('hidden'));
            } else {
                detailCols.forEach(el => el.classList.remove('hidden'));
            }
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if(el) el.innerText = value;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        }
    </script>
</body>
</html>

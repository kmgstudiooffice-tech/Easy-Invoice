<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Invoice - 保存機能付き</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }

        /* 印刷時のスタイル */
        @media print {
            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .print-area {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            @page { margin: 0; size: A4; }
            .invoice-sheet {
                margin: 0;
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                page-break-after: always;
                border: none !important;
                box-shadow: none !important;
            }
        }

        .invoice-sheet {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            /* プレビュー未反映時はぼかすなどの演出用クラス */
            transition: opacity 0.3s;
        }
        
        .blur-preview {
            opacity: 0.5;
            filter: blur(2px);
            pointer-events: none;
        }

        /* ハンコ風スタイル */
        .stamp-box {
            width: 60px;
            height: 60px;
            border: 2px solid #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            font-weight: bold;
            font-size: 14px;
            transform: rotate(-15deg);
            opacity: 0.8;
            position: absolute;
            right: 10px;
            bottom: 10px;
            pointer-events: none;
        }

        /* スクロールバーカスタマイズ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden">

    <!-- 共通ヘッダー -->
    <header class="bg-indigo-600 text-white p-4 shadow-md z-10 no-print flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2 cursor-pointer" onclick="showScreen('home')">
            <i class="fa-solid fa-file-invoice text-2xl"></i>
            <h1 class="text-xl font-bold">Easy Invoice</h1>
        </div>
        <div id="header-actions-home" class="flex gap-2">
            <!-- ホーム画面用のアクション -->
            <button onclick="createNewInvoice()" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-bold hover:bg-indigo-50 transition shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">新規作成</span>
            </button>
        </div>
        <div id="header-actions-editor" class="hidden flex items-center gap-2 sm:gap-4">
            <!-- 編集画面用のアクション -->
            <button onclick="saveInvoice()" class="text-indigo-100 hover:text-white font-medium flex items-center gap-1">
                <i class="fa-regular fa-floppy-disk"></i> <span class="hidden sm:inline">保存</span>
            </button>
            <div class="h-6 w-px bg-indigo-400 mx-1"></div>
            <button onclick="showScreen('home')" class="text-indigo-100 hover:text-white font-medium flex items-center gap-1">
                <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">一覧へ</span>
            </button>
        </div>
    </header>

    <!-- メインコンテンツエリア -->
    <div class="flex-1 overflow-hidden relative bg-gray-100">

        <!-- ==================== ホーム画面 (一覧) ==================== -->
        <div id="screen-home" class="h-full overflow-y-auto p-4 sm:p-8 max-w-5xl mx-auto w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">請求書一覧</h2>
                <div class="text-sm text-gray-500" id="invoice-count">0件</div>
            </div>

            <div id="invoice-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- JSでリスト生成 -->
                <div class="col-span-full text-center py-20 text-gray-400">
                    <i class="fa-regular fa-folder-open text-5xl mb-4"></i>
                    <p>保存された請求書はありません</p>
                    <button onclick="createNewInvoice()" class="mt-4 text-indigo-600 font-bold hover:underline">新規作成する</button>
                </div>
            </div>
        </div>

        <!-- ==================== 編集・プレビュー画面 ==================== -->
        <div id="screen-editor" class="hidden h-full flex flex-col md:flex-row h-full">
            
            <!-- 左側：入力フォーム -->
            <div class="w-full md:w-5/12 lg:w-4/12 bg-white border-r border-gray-200 overflow-y-auto p-4 sm:p-6 no-print pb-24 shadow-inner custom-scrollbar z-10">
                
                <!-- ツールバー -->
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-white/95 backdrop-blur py-2 border-b z-20">
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button onclick="setMode('simple')" id="btn-simple" class="px-3 py-1 rounded-md text-xs font-medium transition-colors bg-white shadow-sm">簡易</button>
                        <button onclick="setMode('detail')" id="btn-detail" class="px-3 py-1 rounded-md text-xs font-medium transition-colors text-gray-500">詳細</button>
                    </div>
                    <button onclick="updatePreview()" class="bg-indigo-600 text-white px-4 py-1.5 rounded-md text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center gap-2 animate-pulse-once">
                        <i class="fa-solid fa-rotate"></i> プレビュー反映
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- 基本情報 -->
                    <section>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">基本情報</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">件名 <span class="text-red-500">*</span></label>
                                <input type="text" id="input-title" placeholder="例: 10月分ご請求" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">請求日</label>
                                    <input type="date" id="input-date" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">請求書番号</label>
                                    <input type="text" id="input-number" placeholder="INV-001" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 取引先・自社情報 -->
                    <section>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">宛名・差出人</h3>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                                <label class="block text-xs font-bold text-blue-800 mb-1">請求先</label>
                                <input type="text" id="input-client" placeholder="相手先の会社名・氏名" class="w-full border-gray-300 border rounded-md p-2 mb-2 bg-white">
                                <input type="text" id="input-client-dept" placeholder="部署・担当者名 (任意)" class="w-full border-gray-300 border rounded-md p-2 text-sm detail-only hidden bg-white">
                            </div>

                            <div class="bg-green-50 p-3 rounded-md border border-green-100">
                                <label class="block text-xs font-bold text-green-800 mb-1">請求元 (自社)</label>
                                <input type="text" id="input-my-company" placeholder="自社の名前" class="w-full border-gray-300 border rounded-md p-2 mb-2 bg-white">
                                <input type="text" id="input-my-address" placeholder="住所" class="w-full border-gray-300 border rounded-md p-2 text-sm mb-2 bg-white">
                                <div class="detail-only hidden">
                                    <input type="text" id="input-my-tel" placeholder="電話番号" class="w-full border-gray-300 border rounded-md p-2 text-sm mb-2 bg-white">
                                    <input type="text" id="input-my-invoice-num" placeholder="登録番号 T1234..." class="w-full border-gray-300 border rounded-md p-2 text-sm bg-white">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 品目リスト -->
                    <section>
                        <div class="flex justify-between items-center mb-3 border-b pb-1">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">請求項目</h3>
                            <button onclick="addItem()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 font-bold"><i class="fa-solid fa-plus"></i> 行追加</button>
                        </div>
                        
                        <div id="items-container" class="space-y-3">
                            <!-- JSで項目が追加されます -->
                        </div>
                    </section>

                    <!-- 備考・振込先 (詳細モードのみ) -->
                    <section class="detail-only hidden">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">振込先・備考</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">振込先銀行</label>
                                <textarea id="input-bank" rows="3" class="w-full border-gray-300 border rounded-md p-2 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">備考</label>
                                <textarea id="input-notes" rows="2" class="w-full border-gray-300 border rounded-md p-2 text-sm"></textarea>
                            </div>
                        </div>
                    </section>

                    <!-- 保存ボタン (SP用) -->
                    <div class="md:hidden pt-4 pb-8">
                        <button onclick="saveInvoice()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-lg">
                            <i class="fa-regular fa-floppy-disk"></i> 保存して一覧に戻る
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右側：プレビューエリア -->
            <div class="flex-1 bg-gray-500 overflow-auto p-4 md:p-8 flex justify-center items-start print-area-wrapper relative">
                
                <!-- プレビュー更新ボタン (Floating) -->
                <div class="absolute top-4 right-4 z-20 flex gap-2 no-print">
                     <button onclick="window.print()" class="bg-white text-gray-700 px-4 py-2 rounded-lg font-bold shadow hover:bg-gray-50 transition flex items-center gap-2">
                        <i class="fa-solid fa-print"></i> 印刷/PDF
                    </button>
                </div>

                <!-- A4用紙 -->
                <div id="invoice-preview" class="invoice-sheet print-area text-black text-sm blur-preview transition-all duration-500">
                    
                    <!-- ヘッダーエリア -->
                    <div class="flex justify-between items-end border-b-2 border-indigo-900 pb-4 mb-8">
                        <h1 id="preview-title" class="text-3xl font-bold text-indigo-900 tracking-widest">請求書</h1>
                        <div class="text-right">
                            <div class="text-gray-500 text-xs">請求書番号</div>
                            <div id="preview-number" class="font-mono text-lg font-bold"></div>
                            <div class="text-gray-500 text-xs mt-1">請求日</div>
                            <div id="preview-date"></div>
                        </div>
                    </div>

                    <!-- 宛名・差出人 -->
                    <div class="flex justify-between mb-12">
                        <div class="w-1/2 pr-4">
                            <div id="preview-client" class="text-xl font-bold border-b border-gray-400 pb-1 mb-1 inline-block min-w-[200px] min-h-[30px]"></div>
                            <span class="text-lg">御中</span>
                            <div id="preview-client-dept" class="mt-1 text-sm text-gray-600"></div>
                            
                            <div class="mt-8">
                                <div class="text-sm bg-gray-100 p-2 inline-block rounded">
                                    <span class="font-bold">ご請求金額</span>
                                    <span id="preview-total-highlight" class="block text-3xl font-bold border-b-2 border-black mt-1">¥0-</span>
                                </div>
                            </div>
                        </div>

                        <div class="w-1/2 pl-4 text-right relative">
                            <div id="preview-my-company" class="text-lg font-bold mb-1 min-h-[28px]"></div>
                            <div id="preview-my-address" class="text-sm text-gray-600 mb-1"></div>
                            <div id="preview-my-tel" class="text-sm text-gray-600 mb-1"></div>
                            <div id="preview-my-invoice-num" class="text-xs text-gray-500 mt-2"></div>
                            
                            <!-- ハンコ -->
                            <div class="stamp-box">
                                検印
                            </div>
                        </div>
                    </div>

                    <!-- 明細テーブル -->
                    <table class="w-full mb-8 border-collapse">
                        <thead>
                            <tr class="bg-indigo-900 text-white">
                                <th class="p-2 text-left w-1/2">内容</th>
                                <th class="p-2 text-center w-16 detail-col">単価</th>
                                <th class="p-2 text-center w-16 detail-col">数量</th>
                                <th class="p-2 text-center w-12 detail-col">単位</th>
                                <th class="p-2 text-right w-24">金額</th>
                            </tr>
                        </thead>
                        <tbody id="preview-items-body">
                            <!-- JSで生成 -->
                        </tbody>
                    </table>

                    <!-- 計算エリア -->
                    <div class="flex justify-end mb-12">
                        <div class="w-1/2 lg:w-1/3">
                            <div class="flex justify-between border-b border-gray-300 py-1">
                                <span>小計 (税抜)</span>
                                <span id="preview-subtotal" class="font-mono">¥0</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-300 py-1 text-xs text-gray-500 detail-col">
                                <span>(内 10%対象)</span>
                                <span id="preview-taxable-10" class="font-mono">¥0</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-300 py-1 text-xs text-gray-500 detail-col">
                                <span>(内 8%対象)</span>
                                <span id="preview-taxable-8" class="font-mono">¥0</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-300 py-1 text-sm">
                                <span>消費税</span>
                                <span id="preview-tax-total" class="font-mono">¥0</span>
                            </div>
                            <div class="flex justify-between border-b-2 border-indigo-900 py-2 text-lg font-bold mt-2">
                                <span>合計金額 (税込)</span>
                                <span id="preview-grand-total" class="font-mono">¥0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 備考・振込先 -->
                    <div class="grid grid-cols-2 gap-8 detail-only hidden">
                        <div>
                            <h4 class="font-bold border-b border-gray-400 mb-2 text-sm">お振込先</h4>
                            <div id="preview-bank" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600"></div>
                        </div>
                        <div>
                            <h4 class="font-bold border-b border-gray-400 mb-2 text-sm">備考</h4>
                            <div id="preview-notes" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600"></div>
                        </div>
                    </div>

                    <!-- プレビュー未反映メッセージ -->
                    <div id="preview-overlay" class="absolute inset-0 flex items-center justify-center bg-white/30 backdrop-blur-[1px] rounded transition-opacity duration-300">
                        <div class="bg-indigo-600 text-white px-6 py-4 rounded-lg shadow-xl text-center">
                            <i class="fa-solid fa-arrow-left text-2xl mb-2 md:hidden"></i>
                            <i class="fa-solid fa-arrow-left text-2xl mb-2 hidden md:inline-block"></i>
                            <p class="font-bold">プレビューを反映</p>
                            <p class="text-xs mt-1">左側の「プレビュー反映」ボタンを<br>押してください</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center gap-3 z-50">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toast-message">保存しました</span>
    </div>

    <script>
        // グローバル変数
        let currentMode = 'simple';
        let items = [];
        let currentInvoiceId = null; // 編集中・新規作成中のID
        let invoiceList = []; // 保存済みデータリスト

        // ローカルストレージキー
        const STORAGE_KEY = 'easy_invoice_data';

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadInvoices();
            showScreen('home');
        });

        // ==================== 画面遷移 ====================
        function showScreen(screenId) {
            const homeScreen = document.getElementById('screen-home');
            const editorScreen = document.getElementById('screen-editor');
            const headerHome = document.getElementById('header-actions-home');
            const headerEditor = document.getElementById('header-actions-editor');

            if (screenId === 'home') {
                homeScreen.classList.remove('hidden');
                editorScreen.classList.add('hidden');
                headerHome.classList.remove('hidden');
                headerEditor.classList.add('hidden');
                loadInvoices(); // リスト更新
            } else {
                homeScreen.classList.add('hidden');
                editorScreen.classList.remove('hidden');
                headerHome.classList.add('hidden');
                headerEditor.classList.remove('hidden');
            }
        }

        // ==================== データ管理 (CRUD) ====================
        
        // データをロード
        function loadInvoices() {
            const data = localStorage.getItem(STORAGE_KEY);
            invoiceList = data ? JSON.parse(data) : [];
            renderInvoiceList();
        }

        // データを保存
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(invoiceList));
        }

        // 新規作成開始
        function createNewInvoice() {
            currentInvoiceId = Date.now().toString(); // ユニークID生成
            clearForm(); // フォームを空にする
            
            // 1行だけ空の項目を追加
            items = [{ id: Date.now(), name: "", price: 0, qty: 1, unit: "式", taxRate: 0.10 }];
            
            setMode('simple');
            renderItems();
            
            // プレビューをリセット（ぼかす）
            document.getElementById('invoice-preview').classList.add('blur-preview');
            document.getElementById('preview-overlay').classList.remove('hidden');
            
            showScreen('editor');
        }

        // 編集開始
        function editInvoice(id) {
            const invoice = invoiceList.find(v => v.id === id);
            if (!invoice) return;

            currentInvoiceId = invoice.id;
            
            // フォームへの値セット
            document.getElementById('input-title').value = invoice.title || '';
            document.getElementById('input-number').value = invoice.number || '';
            document.getElementById('input-date').value = invoice.date || '';
            
            document.getElementById('input-client').value = invoice.client || '';
            document.getElementById('input-client-dept').value = invoice.clientDept || '';
            
            document.getElementById('input-my-company').value = invoice.myCompany || '';
            document.getElementById('input-my-address').value = invoice.myAddress || '';
            document.getElementById('input-my-tel').value = invoice.myTel || '';
            document.getElementById('input-my-invoice-num').value = invoice.myInvoiceNum || '';

            document.getElementById('input-bank').value = invoice.bank || '';
            document.getElementById('input-notes').value = invoice.notes || '';

            items = invoice.items || [];
            currentMode = invoice.mode || 'simple';

            setMode(currentMode);
            renderItems();
            
            // 編集開始時はプレビューを表示しておく
            updatePreview(); 
            showScreen('editor');
        }

        // 現在の状態を保存
        function saveInvoice() {
            // タイトルが空ならデフォルト設定
            let title = document.getElementById('input-title').value;
            if(!title.trim()) {
                title = "名称未設定の請求書";
                document.getElementById('input-title').value = title;
            }

            const data = {
                id: currentInvoiceId,
                updatedAt: new Date().toISOString(),
                title: title,
                number: document.getElementById('input-number').value,
                date: document.getElementById('input-date').value,
                
                client: document.getElementById('input-client').value,
                clientDept: document.getElementById('input-client-dept').value,
                
                myCompany: document.getElementById('input-my-company').value,
                myAddress: document.getElementById('input-my-address').value,
                myTel: document.getElementById('input-my-tel').value,
                myInvoiceNum: document.getElementById('input-my-invoice-num').value,
                
                bank: document.getElementById('input-bank').value,
                notes: document.getElementById('input-notes').value,
                
                items: items,
                mode: currentMode,
                total: calculateTotal() // リスト表示用に合計だけ計算
            };

            // 既存データなら更新、新規なら追加
            const index = invoiceList.findIndex(v => v.id === currentInvoiceId);
            if (index >= 0) {
                invoiceList[index] = data;
            } else {
                invoiceList.unshift(data); // 先頭に追加
            }

            saveToStorage();
            showToast("保存しました");
        }

        function deleteInvoice(id, event) {
            event.stopPropagation(); // 親要素のクリックイベント伝播を阻止
            if(!confirm('本当にこの請求書を削除しますか？')) return;
            
            invoiceList = invoiceList.filter(v => v.id !== id);
            saveToStorage();
            renderInvoiceList();
            showToast("削除しました");
        }

        // リスト描画
        function renderInvoiceList() {
            const container = document.getElementById('invoice-list');
            document.getElementById('invoice-count').innerText = `${invoiceList.length}件`;

            if (invoiceList.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-20 text-gray-400">
                        <i class="fa-regular fa-folder-open text-5xl mb-4"></i>
                        <p>保存された請求書はありません</p>
                        <button onclick="createNewInvoice()" class="mt-4 text-indigo-600 font-bold hover:underline">新規作成する</button>
                    </div>`;
                return;
            }

            container.innerHTML = invoiceList.map(inv => `
                <div onclick="editInvoice('${inv.id}')" class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-indigo-300 transition cursor-pointer relative group">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-indigo-900 truncate pr-8">${inv.title}</h3>
                        <button onclick="deleteInvoice('${inv.id}', event)" class="text-gray-400 hover:text-red-500 transition px-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 mb-4">
                        <p class="truncate"><i class="fa-regular fa-building mr-1"></i> ${inv.client || '（宛名なし）'}</p>
                        <p class="text-xs text-gray-400 mt-1">${inv.date ? formatDate(inv.date) : '日付なし'}</p>
                    </div>
                    <div class="flex justify-between items-end border-t pt-3">
                        <span class="text-xs text-gray-400">合計金額 (税込)</span>
                        <span class="text-xl font-bold text-gray-800">¥${(inv.total || 0).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // ==================== 編集・入力機能 ====================

        function clearForm() {
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => input.value = '');
        }

        function setMode(mode) {
            currentMode = mode;
            const btnSimple = document.getElementById('btn-simple');
            const btnDetail = document.getElementById('btn-detail');
            const detailElements = document.querySelectorAll('.detail-only');
            const detailCols = document.querySelectorAll('.detail-col');

            if (mode === 'simple') {
                btnSimple.className = "px-3 py-1 rounded-md text-xs font-medium transition-colors bg-indigo-600 text-white shadow-sm";
                btnDetail.className = "px-3 py-1 rounded-md text-xs font-medium transition-colors bg-gray-100 text-gray-500 hover:bg-gray-200";
                detailElements.forEach(el => el.classList.add('hidden'));
                // detailColsはプレビュー描画時に制御するためここではCSSクラスの付与のみ
            } else {
                btnSimple.className = "px-3 py-1 rounded-md text-xs font-medium transition-colors bg-gray-100 text-gray-500 hover:bg-gray-200";
                btnDetail.className = "px-3 py-1 rounded-md text-xs font-medium transition-colors bg-indigo-600 text-white shadow-sm";
                detailElements.forEach(el => el.classList.remove('hidden'));
            }
            renderItems();
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-3 border rounded shadow-sm relative group";
                
                div.innerHTML = `
                    <button onclick="removeItem(${index})" class="absolute -right-2 -top-2 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow hover:bg-red-500 z-10 transition-colors">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <div class="grid ${currentMode === 'simple' ? 'grid-cols-3' : 'grid-cols-12'} gap-2 items-end">
                        <div class="${currentMode === 'simple' ? 'col-span-2' : 'col-span-4'}">
                            <label class="text-xs text-gray-500 block">内容</label>
                            <input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)" class="w-full border p-1.5 rounded text-sm bg-white focus:ring-1 focus:ring-indigo-500">
                        </div>
                        
                        <div class="${currentMode === 'simple' ? 'hidden' : 'col-span-2 block'}">
                            <label class="text-xs text-gray-500 block">単価</label>
                            <input type="number" value="${item.price}" onchange="updateItem(${index}, 'price', this.value)" class="w-full border p-1.5 rounded text-sm text-right bg-white focus:ring-1 focus:ring-indigo-500">
                        </div>

                        <div class="${currentMode === 'simple' ? 'hidden' : 'col-span-2 block'}">
                            <label class="text-xs text-gray-500 block">数量</label>
                            <input type="number" value="${item.qty}" onchange="updateItem(${index}, 'qty', this.value)" class="w-full border p-1.5 rounded text-sm text-right bg-white focus:ring-1 focus:ring-indigo-500">
                        </div>

                        <div class="${currentMode === 'simple' ? 'hidden' : 'col-span-1 block'}">
                            <label class="text-xs text-gray-500 block">単位</label>
                            <input type="text" value="${item.unit}" onchange="updateItem(${index}, 'unit', this.value)" class="w-full border p-1.5 rounded text-sm text-center bg-white focus:ring-1 focus:ring-indigo-500">
                        </div>

                        <div class="${currentMode === 'simple' ? 'col-span-1' : 'col-span-3'}">
                            <label class="text-xs text-gray-500 block">金額</label>
                            <input type="number" value="${currentMode === 'simple' ? item.price : (item.price * item.qty)}" 
                                   onchange="${currentMode === 'simple' ? `updateItem(${index}, 'price', this.value)` : ''}" 
                                   ${currentMode === 'detail' ? 'readonly' : ''}
                                   class="w-full border p-1.5 rounded text-sm text-right ${currentMode === 'detail' ? 'bg-gray-200 text-gray-600' : 'bg-white font-bold'}">
                        </div>
                    </div>
                    
                    <div class="${currentMode === 'simple' ? 'hidden' : 'mt-2 flex items-center gap-4 text-xs'}">
                         <label class="flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="tax-${index}" ${item.taxRate === 0.1 ? 'checked' : ''} onchange="updateItem(${index}, 'taxRate', 0.1)">
                            10%
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="tax-${index}" ${item.taxRate === 0.08 ? 'checked' : ''} onchange="updateItem(${index}, 'taxRate', 0.08)">
                            8%(軽減)
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateItem(index, field, value) {
            if (field === 'price' || field === 'qty') {
                items[index][field] = parseFloat(value) || 0;
            } else if (field === 'taxRate') {
                items[index][field] = parseFloat(value);
            } else {
                items[index][field] = value;
            }
            // 配列の値だけ更新し、DOMは再描画しない（フォーカス外れ防止）
            // ただし計算項目の表示更新が必要な場合があるため、簡易的に詳細モードの合計欄だけ更新するロジックを入れてもいいが、
            // 「プレビュー反映」ボタンがあるので、ここではデータ更新のみとする。
            
            // 簡易モードの金額変更時のみ、詳細モード用の計算整合性のため再描画を検討するが、
            // onchangeイベントなのでフォーカスは既に外れている。なのでrenderItemsを呼んでも安全。
            renderItems();
        }

        function addItem() {
            items.push({ id: Date.now(), name: "", price: 0, qty: 1, unit: "式", taxRate: 0.10 });
            renderItems();
        }

        function removeItem(index) {
            items.splice(index, 1);
            renderItems();
        }

        // ==================== プレビュー & 計算 ====================

        function calculateTotal() {
            let subtotal = 0;
            let taxable10 = 0;
            let taxable8 = 0;

            items.forEach(item => {
                const rowTotal = item.price * item.qty;
                subtotal += rowTotal;
                if (item.taxRate === 0.10) taxable10 += rowTotal;
                if (item.taxRate === 0.08) taxable8 += rowTotal;
            });

            const tax10 = Math.floor(taxable10 * 0.10);
            const tax8 = Math.floor(taxable8 * 0.08);
            return subtotal + tax10 + tax8;
        }

        // プレビューのレンダリング（ボタン押下時に発火）
        function updatePreview() {
            // ぼかし解除
            document.getElementById('invoice-preview').classList.remove('blur-preview');
            document.getElementById('preview-overlay').classList.add('hidden');

            // テキスト反映
            setText('preview-title', document.getElementById('input-title').value);
            setText('preview-number', document.getElementById('input-number').value);
            setText('preview-date', formatDate(document.getElementById('input-date').value));
            
            setText('preview-client', document.getElementById('input-client').value);
            setText('preview-client-dept', document.getElementById('input-client-dept').value);
            
            setText('preview-my-company', document.getElementById('input-my-company').value);
            setText('preview-my-address', document.getElementById('input-my-address').value);
            setText('preview-my-tel', document.getElementById('input-my-tel').value);
            setText('preview-my-invoice-num', document.getElementById('input-my-invoice-num').value);

            setText('preview-bank', document.getElementById('input-bank').value);
            setText('preview-notes', document.getElementById('input-notes').value);

            // テーブル行生成
            const tbody = document.getElementById('preview-items-body');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            let taxable10 = 0;
            let taxable8 = 0;

            items.forEach(item => {
                const rowTotal = item.price * item.qty;
                subtotal += rowTotal;
                
                if (item.taxRate === 0.10) taxable10 += rowTotal;
                if (item.taxRate === 0.08) taxable8 += rowTotal;

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200";
                
                const showDetail = currentMode === 'detail';
                const taxMark = (showDetail && item.taxRate === 0.08) ? '<span class="text-xs bg-gray-200 px-1 rounded ml-1">※</span>' : '';

                tr.innerHTML = `
                    <td class="p-2 text-left">${item.name} ${taxMark}</td>
                    <td class="p-2 text-center detail-col ${!showDetail ? 'hidden' : ''}">¥${item.price.toLocaleString()}</td>
                    <td class="p-2 text-center detail-col ${!showDetail ? 'hidden' : ''}">${item.qty}</td>
                    <td class="p-2 text-center detail-col ${!showDetail ? 'hidden' : ''}">${item.unit}</td>
                    <td class="p-2 text-right font-mono">¥${rowTotal.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });

            // 税計算
            const tax10 = Math.floor(taxable10 * 0.10);
            const tax8 = Math.floor(taxable8 * 0.08);
            const taxTotal = tax10 + tax8;
            const grandTotal = subtotal + taxTotal;

            // 金額反映
            setText('preview-subtotal', `¥${subtotal.toLocaleString()}`);
            setText('preview-taxable-10', `¥${taxable10.toLocaleString()}`);
            setText('preview-taxable-8', `¥${taxable8.toLocaleString()}`);
            setText('preview-tax-total', `¥${taxTotal.toLocaleString()}`);
            setText('preview-grand-total', `¥${grandTotal.toLocaleString()}`);
            setText('preview-total-highlight', `¥${grandTotal.toLocaleString()}-`);

            // モードによるCSS制御
            const detailCols = document.querySelectorAll('.detail-col');
            if(currentMode === 'simple') {
                detailCols.forEach(el => el.classList.add('hidden'));
            } else {
                detailCols.forEach(el => el.classList.remove('hidden'));
            }
        }

        // ==================== ユーティリティ ====================

        function setText(id, value) {
            const el = document.getElementById(id);
            if(el) el.innerText = value;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('translate-y-20');
            setTimeout(() => {
                toast.classList.add('translate-y-20');
            }, 3000);
        }
    </script>
</body>
</html>
